<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Bradley Congelio">
<title>Introduction to NFL Analytics with R - 3&nbsp; NFL Analytics with the nflverse Family of Packages</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./04-nfl-analytics-visualization.html" rel="next">
<link href="./02-nfl-analytics-tidyverse.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<script defer="" data-domain="bradcongelio.com/nfl-analytics-with-r-book" src="https://plausible.io/js/script.js"></script><link rel="shortcut icon" href="favicon.ico">
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
<meta property="og:title" content="Introduction to NFL Analytics with R - 3&nbsp; NFL Analytics with the nflverse Family of Packages">
<meta property="og:description" content="">
<meta property="og:image" content="https://bradcongelio.com/nfl-analytics-with-r-book/images/feature.png">
<meta property="og:site-name" content="Introduction to NFL Analytics with R">
<meta property="og:locale" content="es_ES">
<meta property="og:image:height" content="960">
<meta property="og:image:width" content="1344">
<meta name="twitter:title" content="Introduction to NFL Analytics with R - 3&nbsp; NFL Analytics with the nflverse Family of Packages">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://bradcongelio.com/nfl-analytics-with-r-book/images/feature.png">
<meta name="twitter:creator" content="@bradcongelio">
<meta name="twitter:image-height" content="960">
<meta name="twitter:image-width" content="1344">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-nfl-analytics-functions.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">NFL Analytics with the `nflverse` Family of Packages</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to NFL Analytics with R</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/bcongelio/nfl-analytics-with-r-book" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
              <i class="bi bi-bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
</div>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-nfl-analytics-and-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">An Introduction to NFL Analytics and the R Programming Language</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-nfl-analytics-tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Wrangling NFL Data in the <code>tidyverse</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-nfl-analytics-functions.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">NFL Analytics with the <code>nflverse</code> Family of Packages</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-nfl-analytics-visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data Visualization with NFL Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-nfl-analytics-advanced-methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Advanced Model Creation with NFL Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-nfl-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a1-nfl-analytics-dictionary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">NFL Analytics Quick Reference Guide</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a2-nfl-further-reading.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Further Reading Suggestions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a3-nfl-errata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Errata</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#nflreadr-an-introduction-to-the-data" id="toc-nflreadr-an-introduction-to-the-data" class="nav-link active" data-scroll-target="#nflreadr-an-introduction-to-the-data"><span class="header-section-number">3.1</span> <code>nflreadr</code>: An Introduction to the Data</a>
  <ul class="collapse">
<li><a href="#getting-player-stats-via-load_player_stats" id="toc-getting-player-stats-via-load_player_stats" class="nav-link" data-scroll-target="#getting-player-stats-via-load_player_stats"><span class="header-section-number">3.1.1</span> Getting Player Stats via <code>load_player_stats()</code></a></li>
  </ul>
</li>
  <li><a href="#using-load_pbp-to-add-context-to-statistics" id="toc-using-load_pbp-to-add-context-to-statistics" class="nav-link" data-scroll-target="#using-load_pbp-to-add-context-to-statistics"><span class="header-section-number">3.2</span> Using <code>load_pbp()</code> to Add Context to Statistics</a></li>
  <li>
<a href="#more-examples-using-load_pbp-data" id="toc-more-examples-using-load_pbp-data" class="nav-link" data-scroll-target="#more-examples-using-load_pbp-data"><span class="header-section-number">3.3</span> More Examples Using <code>load_pbp()</code> Data</a>
  <ul class="collapse">
<li><a href="#qb-air-yards-epa-by-down" id="toc-qb-air-yards-epa-by-down" class="nav-link" data-scroll-target="#qb-air-yards-epa-by-down"><span class="header-section-number">3.3.1</span> QB Air Yards EPA by Down</a></li>
  <li><a href="#measuring-impact-of-offensive-line" id="toc-measuring-impact-of-offensive-line" class="nav-link" data-scroll-target="#measuring-impact-of-offensive-line"><span class="header-section-number">3.3.2</span> Measuring Impact of Offensive Line</a></li>
  </ul>
</li>
  <li><a href="#retrieving-working-with-data-for-multiple-seasons" id="toc-retrieving-working-with-data-for-multiple-seasons" class="nav-link" data-scroll-target="#retrieving-working-with-data-for-multiple-seasons"><span class="header-section-number">3.4</span> Retrieving &amp; Working With Data for Multiple Seasons</a></li>
  <li>
<a href="#working-with-the-various-nflreadr-functions" id="toc-working-with-the-various-nflreadr-functions" class="nav-link" data-scroll-target="#working-with-the-various-nflreadr-functions"><span class="header-section-number">3.5</span> Working with the Various <code>nflreadr</code> Functions</a>
  <ul class="collapse">
<li><a href="#the-load_participation-function" id="toc-the-load_participation-function" class="nav-link" data-scroll-target="#the-load_participation-function"><span class="header-section-number">3.5.1</span> The <code>load_participation()</code> Function</a></li>
  <li><a href="#the-load_rosters-and-load_rosters_weekly-functions" id="toc-the-load_rosters-and-load_rosters_weekly-functions" class="nav-link" data-scroll-target="#the-load_rosters-and-load_rosters_weekly-functions"><span class="header-section-number">3.5.2</span> The <code>load_rosters()</code> and <code>load_rosters_weekly()</code> Functions</a></li>
  <li><a href="#the-load_teams-function" id="toc-the-load_teams-function" class="nav-link" data-scroll-target="#the-load_teams-function"><span class="header-section-number">3.5.3</span> The <code>load_teams()</code> Function</a></li>
  <li><a href="#the-load_officials-function" id="toc-the-load_officials-function" class="nav-link" data-scroll-target="#the-load_officials-function"><span class="header-section-number">3.5.4</span> The <code>load_officials()</code> Function</a></li>
  <li><a href="#the-load_trades-function" id="toc-the-load_trades-function" class="nav-link" data-scroll-target="#the-load_trades-function"><span class="header-section-number">3.5.5</span> The <code>load_trades()</code> Function</a></li>
  <li><a href="#the-load_draft_picks-function" id="toc-the-load_draft_picks-function" class="nav-link" data-scroll-target="#the-load_draft_picks-function"><span class="header-section-number">3.5.6</span> The <code>load_draft_picks()</code> Function</a></li>
  <li><a href="#the-load_combine-function" id="toc-the-load_combine-function" class="nav-link" data-scroll-target="#the-load_combine-function"><span class="header-section-number">3.5.7</span> The <code>load_combine()</code> Function</a></li>
  <li><a href="#the-load_nextgen_stats-function" id="toc-the-load_nextgen_stats-function" class="nav-link" data-scroll-target="#the-load_nextgen_stats-function"><span class="header-section-number">3.5.8</span> The <code>load_nextgen_stats()</code> Function</a></li>
  <li><a href="#the-load_espn_qbr-function" id="toc-the-load_espn_qbr-function" class="nav-link" data-scroll-target="#the-load_espn_qbr-function"><span class="header-section-number">3.5.9</span> The <code>load_espn_qbr()</code> Function</a></li>
  <li><a href="#the-load_pfr_advstats-function" id="toc-the-load_pfr_advstats-function" class="nav-link" data-scroll-target="#the-load_pfr_advstats-function"><span class="header-section-number">3.5.10</span> The <code>load_pfr_advstats()</code> Function</a></li>
  <li><a href="#the-load_snap_counts-function" id="toc-the-load_snap_counts-function" class="nav-link" data-scroll-target="#the-load_snap_counts-function"><span class="header-section-number">3.5.11</span> The <code>load_snap_counts()</code> Function</a></li>
  <li><a href="#the-load_contracts-function" id="toc-the-load_contracts-function" class="nav-link" data-scroll-target="#the-load_contracts-function"><span class="header-section-number">3.5.12</span> The <code>load_contracts()</code> Function</a></li>
  <li><a href="#the-load_ftn_charting-function" id="toc-the-load_ftn_charting-function" class="nav-link" data-scroll-target="#the-load_ftn_charting-function"><span class="header-section-number">3.5.13</span> The <code>load_ftn_charting()</code> Function</a></li>
  </ul>
</li>
  <li>
<a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">3.6</span> Exercises</a>
  <ul class="collapse">
<li><a href="#exercise-1" id="toc-exercise-1" class="nav-link" data-scroll-target="#exercise-1"><span class="header-section-number">3.6.1</span> <strong>Exercise 1</strong></a></li>
  <li><a href="#exercise-2" id="toc-exercise-2" class="nav-link" data-scroll-target="#exercise-2"><span class="header-section-number">3.6.2</span> Exercise 2</a></li>
  <li><a href="#exercise-3" id="toc-exercise-3" class="nav-link" data-scroll-target="#exercise-3"><span class="header-section-number">3.6.3</span> Exercise 3</a></li>
  <li><a href="#exercise-4" id="toc-exercise-4" class="nav-link" data-scroll-target="#exercise-4"><span class="header-section-number">3.6.4</span> Exercise 4</a></li>
  <li><a href="#exercise-5" id="toc-exercise-5" class="nav-link" data-scroll-target="#exercise-5"><span class="header-section-number">3.6.5</span> Exercise 5</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/bcongelio/nfl-analytics-with-r-book/edit/origin/03-nfl-analytics-functions.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/bcongelio/nfl-analytics-with-r-book/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">3</span>&nbsp; <span class="chapter-title">NFL Analytics with the <code>nflverse</code> Family of Packages</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>As mentioned in the Preface of this book, the <code>nflverse</code> has drastically expanded since the inception of <code>nflfastR</code> in April of 2020. In total, the current version of the <code>nflverse</code> is comprised of five separate R packages:</p>
<ol type="1">
<li><code>nflfastR</code></li>
<li><code>nflseedR</code></li>
<li><code>nfl4th</code></li>
<li><code>nflreadr</code></li>
<li><code>nflplotR</code></li>
</ol>
<p>Installing the <code>nflverse</code> as a package in R will automatically install all five packages. However, the core focus of this book will be on <code>nflreadr</code>. It is understandable if you are confused by that, since the Preface of this book introduced the <code>nflfastR</code> package. The <code>nflreadr</code> package, as explained by its author (<a href="https://tanho.ca/">Tan Ho</a>), is a “minimal package for downloading data from <code>nflverse</code> repositories.” The data that <em>is</em> the <code>nflverse</code> is stored across five different GitHub repositories. Using <code>nflreadr</code> allows for easy access to any of these data sources. For lack of a better term, <code>nflreadr</code> acts as a shortcut of sorts while also operating with less dependencies.</p>
<p>As you will see in this chapter, using <code>nflreadr::</code> while coding provides nearly identical functions to those available when using <code>nflfastR::</code>. In fact, <code>nflfastR::</code>, in many instances, now calls, “under the hood,” the equivalent function in <code>nflreadr::</code>. Because of the coalescing between the two, many of the new functions being developed are available only when using <code>nflreadr::</code>. For example, <code>nflreadr::</code> allows you to access data pertaining to the NFL Combine, draft picks, contracts, trades, injury information, and access to statistics on Pro Football Reference.</p>
<p>While <code>nflfastR</code> did initially serve as the foundation of the “amateur NFL analytics” movement, the <code>nflreadr</code> package has superseded it and now serves as the “catchall” package for all the various bits and pieces of the <code>nflverse</code>. Because of this, and to maintain consistency throughout, this book - nearly exclusively - will use <code>nflreadr::</code> when calling functions housed within the <code>nflverse</code> rather than <code>nflfastR::</code>.</p>
<p>The below diagram visualizes the relationship between <code>nflfastR</code> and <code>nflreadr</code>.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/nflverse-comparison_0f11bdc2a5dabddb99944258391866a9">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/updated-diagram.png" style="width:95.0%;height:95.0%" class="figure-img"></p>
<figcaption class="figure-caption">Comparison of nflreadr and nflfastR</figcaption></figure>
</div>
</div>
</div>
<p>The purpose of this chapter is to explore <code>nflreadr</code> data in an introductory fashion using, what I believe, are the two most important functions in the <code>nflverse</code>: (1.) <code>load_player_stats()</code> and (2.) <code>load_pbp()</code>. It makes the assumption that you are versed in the R programming language. If you are not, please start with Chapter 2 where you can learn about R and the <code>tidyverse</code> language using examples from the <code>nflverse</code>.</p>
<section id="nflreadr-an-introduction-to-the-data" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="nflreadr-an-introduction-to-the-data">
<span class="header-section-number">3.1</span> <code>nflreadr</code>: An Introduction to the Data</h2>
<p>The most important part of the <code>nflverse</code> is, of course, the data. To begin, we will examine the core data that underpins the <code>nflverse</code>: weekly player stats and the more detailed play-by–play data. Using <code>nflreadr</code>, the end user is able to collect weekly top-level stats via the <code>load_player_stats()</code> function or the much more robust play-by-play numbers by using the <code>load_pbp()</code> function.</p>
<p>As you may imagine, there is a <strong>very important distinction between the <code>load_player_stats()</code></strong> <strong>and <code>load_pbp()</code></strong>. As mentioned, <code>load_player_stats()</code> will provide you with weekly, pre-calculated statistics for either offense or kicking. Conversely, <code>load_pbp()</code> will provide over 350 metrics for every single play of every single game dating back to 1999.</p>
<p>The <code>load_player_stats()</code> function includes the following offensive information:</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/load_player_stats-information_98d77168f0031ce329b24ee134d88651">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">offensive.stats</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span><span class="fl">2021</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="va">offensive.stats</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "air_yards_share"             "attempts"                   
 [3] "carries"                     "completions"                
 [5] "dakota"                      "fantasy_points"             
 [7] "fantasy_points_ppr"          "headshot_url"               
 [9] "interceptions"               "pacr"                       
[11] "passing_2pt_conversions"     "passing_air_yards"          
[13] "passing_epa"                 "passing_first_downs"        
[15] "passing_tds"                 "passing_yards"              
[17] "passing_yards_after_catch"   "player_display_name"        
[19] "player_id"                   "player_name"                
[21] "position"                    "position_group"             
[23] "racr"                        "receiving_2pt_conversions"  
[25] "receiving_air_yards"         "receiving_epa"              
[27] "receiving_first_downs"       "receiving_fumbles"          
[29] "receiving_fumbles_lost"      "receiving_tds"              
[31] "receiving_yards"             "receiving_yards_after_catch"
[33] "recent_team"                 "receptions"                 
[35] "rushing_2pt_conversions"     "rushing_epa"                
[37] "rushing_first_downs"         "rushing_fumbles"            
[39] "rushing_fumbles_lost"        "rushing_tds"                
[41] "rushing_yards"               "sack_fumbles"               
[43] "sack_fumbles_lost"           "sack_yards"                 
[45] "sacks"                       "season"                     
[47] "season_type"                 "special_teams_tds"          
[49] "target_share"                "targets"                    
[51] "week"                        "wopr"                       </code></pre>
</div>
</div>
<p>As well, switching the <code>stat_type</code> to “kicking” provides the following information:</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/load_player_stats-kicking_6fe238c7ae7c2952b03612c9904109bd">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">kicking.stats</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span><span class="fl">2021</span>,</span>
<span>                                             stat_type <span class="op">=</span> <span class="st">"kicking"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="va">kicking.stats</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "fg_att"              "fg_blocked"          "fg_blocked_distance"
 [4] "fg_blocked_list"     "fg_long"             "fg_made"            
 [7] "fg_made_0_19"        "fg_made_20_29"       "fg_made_30_39"      
[10] "fg_made_40_49"       "fg_made_50_59"       "fg_made_60_"        
[13] "fg_made_distance"    "fg_made_list"        "fg_missed"          
[16] "fg_missed_0_19"      "fg_missed_20_29"     "fg_missed_30_39"    
[19] "fg_missed_40_49"     "fg_missed_50_59"     "fg_missed_60_"      
[22] "fg_missed_distance"  "fg_missed_list"      "fg_pct"             
[25] "gwfg_att"            "gwfg_blocked"        "gwfg_distance"      
[28] "gwfg_made"           "gwfg_missed"         "pat_att"            
[31] "pat_blocked"         "pat_made"            "pat_missed"         
[34] "pat_pct"             "player_id"           "player_name"        
[37] "season"              "season_type"         "team"               
[40] "week"               </code></pre>
</div>
</div>
<p>While the data returned is not as rich as the play-by-play data we will covering next, the <code>load_player_stats()</code> function is extremely helpful when you need to quickly (and correctly!) recreate the official stats listed on either the NFL’s website or on <a href="https://www.pro-football-reference.com/">Pro Football Reference</a>.</p>
<p>As an example, let’s say you need to get Patrick Mahomes’ total passing yard and attempts from the 2022 season. You could do so via <code>load_pbp()</code> but, if you do not need further context (such as down, distance, quarter, etc.), using <code>load_player_stats()</code> is much more efficient.</p>
<section id="getting-player-stats-via-load_player_stats" class="level3" data-number="3.1.1"><h3 data-number="3.1.1" class="anchored" data-anchor-id="getting-player-stats-via-load_player_stats">
<span class="header-section-number">3.1.1</span> Getting Player Stats via <code>load_player_stats()</code>
</h3>
<p>We can generate a data frame titled <code>mahomes_pyards</code> but running the following code:</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/loading-mahomes-stats_5907687f3a7bede5bfb742926843c4f3">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mahomes_pyards</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the above example, we specified that the returned data be from the 2022 season. It needs to be noted that running <code>load_player_stats()</code> (without a specific season) will return the newest season in the data. Moreover, separating two seasons with a colon (<code>:</code>) will provide multiple seasons of data. In our working example, the <code>mahomes_pyards</code> data frame contains statistics for every player from every week of the 2022 season.</p>
<p>It is important to note that the structure of the data returned by <code>load_player_stats()</code> includes passing yards, rushing yards, receiving yards, etc. for each player. As a result, the data returns - for example - the week-by-week statistics for rushing and receiving for Peyton Manning, not just his passing numbers. Because of this, we can calculate Peyton’s rushing statistics from 2000 to 2022.</p>
<pre><code># A tibble: 1 x 4
  carries rushing_yards rushing_tds rush_epa
    &lt;int&gt;         &lt;dbl&gt;       &lt;int&gt;    &lt;dbl&gt;
1     409           531          18   -0.740</code></pre>
<p>Knowing that Peyton’s average rushing EPA from 2000 to the end of his career was -0.740 is not going to win you final Jeopardy nor is it going to be helpful in any sort of Twitter football discourse (as opposed to knowing the rushing EPA for Patrick Mahomes who is, for lack of a better term, a bit more nimble on the run). When working with <code>load_player_stats()</code>, it is important that you know the variable names that are useful to the research you are doing.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The relevant passing statistics housed in <code>load_player_stats()</code> includes:</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/player-stats-passing_f122579a31a6da150fd12f8b2c5e505e">
<div class="cell-output cell-output-stdout">
<pre><code> [1] "completions"               "attempts"                 
 [3] "passing_yards"             "passing_tds"              
 [5] "interceptions"             "sacks"                    
 [7] "sack_yards"                "sack_fumbles"             
 [9] "sack_fumbles_lost"         "passing_air_yards"        
[11] "passing_yards_after_catch" "passing_first_downs"      
[13] "passing_epa"               "passing_2pt_conversions"  
[15] "pacr"                      "dakota"                   </code></pre>
</div>
</div>
<p>The columns relevant to rushing statistics in <code>load_player_stats()</code> are:</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/player-stats-rushing_d352a72c198a21a0ad2567e51bc37b1b">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "carries"                 "rushing_yards"          
[3] "rushing_tds"             "rushing_fumbles"        
[5] "rushing_fumbles_lost"    "rushing_first_downs"    
[7] "rushing_epa"             "rushing_2pt_conversions"</code></pre>
</div>
</div>
<p>Lastly, the columns for receiving statistics in <code>load_player_stats()</code> include:</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/player-stats-receiving_0f39619aa06242d8ed9b99a601a88876">
<div class="cell-output cell-output-stdout">
<pre><code> [1] "receptions"                  "targets"                    
 [3] "receiving_yards"             "receiving_tds"              
 [5] "receiving_fumbles"           "receiving_fumbles_lost"     
 [7] "receiving_air_yards"         "receiving_yards_after_catch"
 [9] "receiving_first_downs"       "receiving_epa"              
[11] "receiving_2pt_conversions"   "racr"                       
[13] "target_share"                "air_yards_share"            </code></pre>
</div>
</div>
</div>
</div>
<p>Continuing with our above example working with <code>load_player_stats()</code> and Patrick Mahomes, we can find his total passing yards during the 2022 regular season by using the <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> function to sort the data for either <code>player_name</code> or <code>player_display_name</code> as well the the <code>season_type</code> and then use <code>summarize()</code> to get the total of his <code>passing_yards</code> over the course of the regular season.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/getting-mahomes-pyards_5bf6099c3b8243632b48f109b983a468">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mahomes_pyards</span> <span class="op">&lt;-</span> <span class="va">mahomes_pyards</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">player_name</span> <span class="op">==</span> <span class="st">"P.Mahomes"</span> <span class="op">&amp;</span> <span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>passing_yards <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">passing_yards</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mahomes_pyards</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 x 1
  passing_yards
          &lt;dbl&gt;
1          5250</code></pre>
</div>
</div>
<p>The above code returns a result of 5,250 passing yards which is an exact match from the data provided by <a href="https://www.pro-football-reference.com/players/M/MahoPa00.htm">Pro Football Reference.</a> In the above example, we used the <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> function on the <code>player_name</code> column in the data. You will get the same result if you replace that with <code>player_display_name == "Patrick Mahomes"</code>. While there is no difference in how the data is collected, there will be a difference if you were to visualize the data frame and wished to display the player names along with their respective statistics. In most cases, in order to maintain a clean design, using the <code>player_name</code> option is best as it allows you to plot just the player’s first initial and last name.</p>
<p>We can build upon the passing yards example to replicate the vast majority of statistics found in the<a href="https://www.pro-football-reference.com/players/M/MahoPa00.htm#passing">“Passing” data table for Mahomes from Pro Football Reference</a>.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/mahomes-replicate-pfr_0e7ecf1b0ab08090182325ae8d8dfca4">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mahomes_pfr</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">player_name</span> <span class="op">==</span> <span class="st">"P.Mahomes"</span> <span class="op">&amp;</span> <span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    completions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">completions</span><span class="op">)</span>,</span>
<span>    attempts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">attempts</span><span class="op">)</span>,</span>
<span>    cmp_pct <span class="op">=</span> <span class="va">completions</span> <span class="op">/</span> <span class="va">attempts</span>,</span>
<span>    yards <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">passing_yards</span><span class="op">)</span>,</span>
<span>    touchdowns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">passing_tds</span><span class="op">)</span>,</span>
<span>    td_pct <span class="op">=</span> <span class="va">touchdowns</span> <span class="op">/</span> <span class="va">attempts</span> <span class="op">*</span> <span class="fl">100</span>,</span>
<span>    interceptions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">interceptions</span><span class="op">)</span>,</span>
<span>    int_pct <span class="op">=</span> <span class="va">interceptions</span> <span class="op">/</span> <span class="va">attempts</span> <span class="op">*</span> <span class="fl">100</span>,</span>
<span>    first_down <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">passing_first_downs</span><span class="op">)</span>,</span>
<span>    yards_attempt <span class="op">=</span> <span class="va">yards</span> <span class="op">/</span> <span class="va">attempts</span>,</span>
<span>    adj_yards_attempt <span class="op">=</span> <span class="op">(</span><span class="va">yards</span> <span class="op">+</span> <span class="fl">20</span> <span class="op">*</span> <span class="va">touchdowns</span> <span class="op">-</span> <span class="fl">45</span> <span class="op">*</span> <span class="va">interceptions</span><span class="op">)</span> <span class="op">/</span> <span class="va">attempts</span>,</span>
<span>    yards_completions <span class="op">=</span> <span class="va">yards</span> <span class="op">/</span> <span class="va">completions</span>,</span>
<span>    yards_game <span class="op">=</span> <span class="va">yards</span> <span class="op">/</span> <span class="fl">17</span>,</span>
<span>    sacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">sacks</span><span class="op">)</span>,</span>
<span>    sack_yards <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">sack_yards</span><span class="op">)</span>,</span>
<span>    sack_pct <span class="op">=</span> <span class="va">sacks</span> <span class="op">/</span> <span class="op">(</span><span class="va">attempts</span> <span class="op">+</span> <span class="va">sacks</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mahomes_pfr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 x 16
  completions attempts cmp_pct yards touchdowns td_pct interceptions
        &lt;int&gt;    &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;      &lt;int&gt;  &lt;dbl&gt;         &lt;dbl&gt;
1         435      648   0.671  5250         41   6.33            12
# i 9 more variables: int_pct &lt;dbl&gt;, first_down &lt;dbl&gt;,
#   yards_attempt &lt;dbl&gt;, adj_yards_attempt &lt;dbl&gt;, ...</code></pre>
</div>
</div>
<p>What if we wanted to find Mahomes’ adjusted yards gained per pass attempt for every one of his seasons between 2018 and 2022? It is as simple as gathering all the data from years (<code>seasons = 2018:2022</code>), using the same <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> from above, and then using <code>group_by()</code> on the <code>season</code> variable.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/mahomes-career-adjusted_bfcf2b85ed91bbd7af93b3c655612ab9">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mahomes_adjusted_yards</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2018</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">player_name</span> <span class="op">==</span> <span class="st">"P.Mahomes"</span> <span class="op">&amp;</span> <span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">season</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    adj_yards_attempt <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">passing_yards</span><span class="op">)</span> <span class="op">+</span> <span class="fl">20</span> <span class="op">*</span></span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">passing_tds</span><span class="op">)</span> <span class="op">-</span> <span class="fl">45</span> <span class="op">*</span></span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">interceptions</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">attempts</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mahomes_adjusted_yards</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 x 2
  season adj_yards_attempt
   &lt;int&gt;             &lt;dbl&gt;
1   2018              9.58
2   2019              8.94
3   2020              8.89
4   2021              7.59
5   2022              8.53</code></pre>
</div>
</div>
<p>Based on the data output, Mahomes’ best year for adjusted yards gained per pass attempt was 2018 with 9.58 adjusted yards. How does this compare to other quarterbacks from the same season? We can find the answer by doing slight modifications to our above code. Rather than filtering the information out to just Patrick Mahomes, we will add the <code>player_name</code> variable as the argument in the <code>group_by()</code> function.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/all-qbs-adjusted_b501f6a3912a856485ed2dcea0a20a58">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">all_qbs_adjusted</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2018</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span> <span class="op">&amp;</span> <span class="va">position</span> <span class="op">==</span> <span class="st">"QB"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">player_name</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    adj_yards_attempt <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">passing_yards</span><span class="op">)</span> <span class="op">+</span> <span class="fl">20</span> <span class="op">*</span></span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">passing_tds</span><span class="op">)</span> <span class="op">-</span> <span class="fl">45</span> <span class="op">*</span></span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">interceptions</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">attempts</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">adj_yards_attempt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all_qbs_adjusted</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 73 x 2
   player_name   adj_yards_attempt
   &lt;chr&gt;                     &lt;dbl&gt;
 1 N.Sudfeld                 21   
 2 G.Gilbert                 13.3 
 3 M.Barkley                 11.7 
 4 K.Allen                    9.87
 5 C.Henne                    9.67
 6 P.Mahomes                  9.58
 7 M.Glennon                  9.24
 8 D.Brees                    9.01
 9 R.Wilson                   8.98
10 R.Fitzpatrick              8.80
# i 63 more rows</code></pre>
</div>
</div>
<p>Mahomes, with an adjusted yards per pass attempt of 9.58, finishes in sixth place in the 2018 season behind C. Henne (9.67), K. Allen (9.87), and then three others that have results between 10 and 20. This is a situation where I tell my students the results do not pass the “eye test.” Why? It is unlikely that an adjusted yards per pass attempt of 21 and 13.3 for Nate Sudfeld and Garrett Gilbert, respectively, are from a season worth of data. The results for Kyle Allen and Matt Barkley are questionable, as well.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>You will often discover artificially-inflated statistics like above when the players have limited number of pass attempts/rushing attempts/receptions/etc. compared to the other players on the list. To confirm this, we can add <code>pass_attempts = sum(attempts)</code> to the above code to compare the number of attempts Sudfeld and Gilbert had compared to the rest of the list.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/qbs-adjusted-w-attempts_dfaee6c5f023ea3104bf9347668eebe9">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">all_qbs_adjusted_with_attempts</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2018</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span> <span class="op">&amp;</span> <span class="va">position</span> <span class="op">==</span> <span class="st">"QB"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">player_name</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    pass_attempts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">attempts</span><span class="op">)</span>,</span>
<span>    adj_yards_attempt <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">passing_yards</span><span class="op">)</span> <span class="op">+</span> <span class="fl">20</span> <span class="op">*</span></span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">passing_tds</span><span class="op">)</span> <span class="op">-</span> <span class="fl">45</span> <span class="op">*</span></span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">interceptions</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">attempts</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">adj_yards_attempt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all_qbs_adjusted_with_attempts</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 73 x 3
   player_name   pass_attempts adj_yards_attempt
   &lt;chr&gt;                 &lt;int&gt;             &lt;dbl&gt;
 1 N.Sudfeld                 2             21   
 2 G.Gilbert                 3             13.3 
 3 M.Barkley                25             11.7 
 4 K.Allen                  31              9.87
 5 C.Henne                   3              9.67
 6 P.Mahomes               580              9.58
 7 M.Glennon                21              9.24
 8 D.Brees                 489              9.01
 9 R.Wilson                427              8.98
10 R.Fitzpatrick           246              8.80
# i 63 more rows</code></pre>
</div>
</div>
<p>The results are even worse than initially thought. There are a total of six players with an inflated adjusted yards per pass attempt:</p>
<ol type="1">
<li>Nate Sudfeld (2 attempts, 21 adjusted yards).</li>
<li>Garrett Gilbert (3 attempts, 13.3 adjusted yards).</li>
<li>Matt Barkley (25 attempts, 11.7 adjusted yards).</li>
<li>Kyle Allen (31 attempts, 9.87 adjusted yards).</li>
<li>Chris Henne (3 attempts, 9.67 adjusted yards).</li>
</ol>
<p>To remove those players with inflated statistics resulting from a lack of attempts, we can apply a second <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> at the end of our above code to limit the results to just those quarterbacks with no less than 100 pass attempts in the 2018 season.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/all-qbs-attempts-100_ef483ce6a56c9e747c79c00233f30202">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">all_qbs_attempts_100</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2018</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span> <span class="op">&amp;</span> <span class="va">position</span> <span class="op">==</span> <span class="st">"QB"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">player_name</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    pass_attempts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">attempts</span><span class="op">)</span>,</span>
<span>    adj_yards_attempt <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">passing_yards</span><span class="op">)</span> <span class="op">+</span> <span class="fl">20</span> <span class="op">*</span></span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">passing_tds</span><span class="op">)</span> <span class="op">-</span> <span class="fl">45</span> <span class="op">*</span></span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">interceptions</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">attempts</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">pass_attempts</span> <span class="op">&gt;=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">adj_yards_attempt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all_qbs_attempts_100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>After including a <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> to the code to remove those quarterbacks with less than 100 attempts, it is clear that Mahomes has the best adjusted pass yards per attempt (9.58) in the 2018 season with Drew Brees in second place with 9.01. Based on our previous examples, we know that a Mahomes 9.58 adjusted pass yards per attempt in 2018 was his career high (and is also the highest in the 2018 season). How do his other seasons stack up? Is his lowest adjusted pass yards (7.59) in 2021 still the best among NFL quarterbacks in that specific season?</p>
<p>To find the answer, we can make slight adjustments to our existing code.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/best-adjusted-yards_8d576fc9db0f1b919250f4fcc03f94a4">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">best_adjusted_yards</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2018</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span> <span class="op">&amp;</span> <span class="va">position</span> <span class="op">==</span> <span class="st">"QB"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">season</span>, <span class="va">player_name</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    pass_attempts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">attempts</span><span class="op">)</span>,</span>
<span>    adj_yards_attempt <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">passing_yards</span><span class="op">)</span> <span class="op">+</span> <span class="fl">20</span> <span class="op">*</span></span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">passing_tds</span><span class="op">)</span> <span class="op">-</span> <span class="fl">45</span> <span class="op">*</span></span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">interceptions</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">attempts</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">pass_attempts</span> <span class="op">&gt;=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">season</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">adj_yards_attempt</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">adj_yards_attempt</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span><span class="va">best_adjusted_yards</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 x 4
# Groups:   season [5]
  season player_name  pass_attempts adj_yards_attempt
   &lt;int&gt; &lt;chr&gt;                &lt;int&gt;             &lt;dbl&gt;
1   2018 P.Mahomes              580              9.58
2   2019 R.Tannehill            286             10.2 
3   2020 A.Rodgers              526              9.57
4   2021 J.Burrow               520              8.96
5   2022 T.Tagovailoa           400              9.22</code></pre>
</div>
</div>
<p>To get the answer, we’ve created code that follows along with our prior examples. However, after using <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> to limit the number of attempts each quarterback must have, we use <code>ungroup()</code> to remove the previous grouping between <code>season</code> and <code>player_name</code> and then use <code>group_by()</code> again on just the <code>season</code> information in the data. After, we use <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> to select just the highest adjusted yards per attempt for each individual season. As a result, we can see that Mahomes only led the NFL in this specific metric in the 2018 season. In fact, between the 2018 and 2022 seasons, Ryan Tannehill had the highest adjusted yards per attempt with 10.2 (but notice he had just 286 passing attempts).</p>
<p>As mentioned, the <code>load_player_stats()</code> information is provided on a week-by-week basis. In our above example, we are aggregating all regular season weeks into a season-long metric. Given the structure of the data, we can take a similar approach but to determine the leaders on a week-by-week basis. To showcase this, we can determine the leader in rushing EPA for every week during the 2022 regular season.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/rushing-epa-leaders_268031ea85c40589dcd1b7d4924e938a">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rushing_epa_leader</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span>season <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span> <span class="op">&amp;</span> <span class="va">position</span> <span class="op">==</span> <span class="st">"RB"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">rushing_epa</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">week</span>, <span class="va">player_name</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    carries <span class="op">=</span> <span class="va">carries</span>,</span>
<span>    rush_epa <span class="op">=</span> <span class="va">rushing_epa</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">carries</span> <span class="op">&gt;=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">week</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">rush_epa</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">rush_epa</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/showing-rushing-epa-leader_4bb9f1969e119123643f9393f6b74151">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 18 x 4
# Groups:   week [18]
    week player_name carries rush_epa
   &lt;int&gt; &lt;chr&gt;         &lt;int&gt;    &lt;dbl&gt;
 1     1 D.Swift          15    10.0 
 2     2 A.Jones          15     8.08
 3     3 C.Patterson      17     5.76
 4     4 R.Penny          17     9.73
 5     5 A.Ekeler         16    11.6 
 6     6 K.Drake          10     6.72
 7     7 J.Jacobs         20     6.93
 8     8 T.Etienne        24     9.68
 9     9 J.Mixon          22    11.3 
10    10 A.Jones          24     5.47
11    11 J.Cook           11     2.92
12    12 M.Sanders        21     6.72
13    13 T.Pollard        12     3.97
14    14 M.Sanders        17     8.95
15    15 T.Allgeier       17    10.5 
16    16 D.Foreman        21     7.22
17    17 A.Ekeler         10    10.0 
18    18 A.Mattison       10     5.85</code></pre>
</div>
</div>
<p>Rather than using the <code>season</code> variable in the <code>group_by()</code> function, we instead use <code>week</code> to calculate the leader in rushing EPA. The results show that the weekly leader is varied, with only Austin Ekeler and Aaron Jones appearing on the list more than once. The Bengals’ Joe Mixon produced the largest rushing EPA in the 2022 season, recording 11.3 in week 9 while James Cook’s 2.92 output in week 11 was the “least” of the best weekly performances.</p>
<p>Much like we did with the passing statistics, we can use the rushing data in <code>load_player_stats()</code> to replicate the majority found on Pro Football Reference. To do so, let’s use Joe Mixon’s week 9 performance from the 2022 season.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/mixon-week-9_a421a8fc143547df4e4d37f33464c108">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mixon_week_9</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">player_name</span> <span class="op">==</span> <span class="st">"J.Mixon"</span> <span class="op">&amp;</span> <span class="va">week</span> <span class="op">==</span> <span class="fl">9</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    rushes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">carries</span><span class="op">)</span>,</span>
<span>    yards <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">rushing_yards</span><span class="op">)</span>,</span>
<span>    yards_att <span class="op">=</span> <span class="va">yards</span> <span class="op">/</span> <span class="va">rushes</span>,</span>
<span>    tds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">rushing_tds</span><span class="op">)</span>,</span>
<span>    first_down <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">rushing_first_downs</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mixon_week_9</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 x 5
  rushes yards yards_att   tds first_down
   &lt;int&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;int&gt;      &lt;dbl&gt;
1     22   153      6.95     4         12</code></pre>
</div>
</div>
<p>Mixon gained a total of 153 yards on the ground on 22 carries, which is just under 7 yards per attempt. Four of those carries resulting in touchdowns, while 12 of them kept drives alive with first downs. Other contextual statistics for this performance, such as yards after contact, are not included in <code>load_player_stats()</code> but can be retrieved using other functions within the <code>nflverse()</code> (which are covered later in this chapter).</p>
<p>Finally, we can use the <code>load_player_stats()</code> function to explore wide receiver performances. As listed above, the wide receivers statistics housed within <code>load_player_stats()</code> include those to be expected: yards, touchdowns, air yards, yards after catch, etc. Rather than working with those in an example, let’s use <code>wopr</code> which stands for <code>Weighted Opportunity Rating</code>, which is a weighted average that contextualizes how much value any one wide receivers bring to a fantasy football team. The equation is already built into the data, but for clarity it is as follows:</p>
<p><span class="math display">\[
1.5 * target share + 0.7 * air yards share
\]</span></p>
<p>We can use <code>wopr</code> to determine which wide receiver was the most valuable to fantasy football owners during the 2022 season.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/receivers-wopr_f9c8942cfb0215a8df4ff2f7f988fc7c">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">receivers_wopr</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span> <span class="op">&amp;</span> <span class="va">position</span> <span class="op">==</span> <span class="st">"WR"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">player_name</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    total_wopr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">wopr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">total_wopr</span><span class="op">)</span></span>
<span></span>
<span><span class="va">receivers_wopr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 225 x 2
   player_name total_wopr
   &lt;chr&gt;            &lt;dbl&gt;
 1 D.Moore           13.9
 2 D.Adams           13.4
 3 T.Hill            12.4
 4 A.Brown           12.2
 5 J.Jefferson       11.9
 6 C.Lamb            11.8
 7 A.Cooper          11.8
 8 D.Johnson         11.2
 9 D.London          10.9
10 D.Metcalf         10.7
# i 215 more rows</code></pre>
</div>
</div>
<p>D.J. Moore led the NFL in the 2022 season with a 13.9 Weighted Opportunity Rating, followed closely by Davante Adams with 13.4. However, before deciding that D.J. Moore is worth the number one pick in your upcoming fantasy football draft, it is worth exploring if there is a relationship between a high Weight Opportunity Rating and a player’s total fantasy points. To do so, we can take our above code that was used to gather each player’s <code>WOPR</code> over the course of the season and add <code>total_ff = sum(fantasy_points)</code> and also calculate a new metric called “Fantasy Points per Weighted Opportunity” which is simply the total of a player’s points divided by the <code>wopr</code>.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/wopr-plus-fantasy_a287af5f80e3a41facfbaf4e94ec0c16">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">receivers_wopr_ff_context</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span> <span class="op">&amp;</span> <span class="va">position</span> <span class="op">==</span> <span class="st">"WR"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">player_name</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    total_wopr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">wopr</span><span class="op">)</span>,</span>
<span>    total_ff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">fantasy_points</span><span class="op">)</span>,</span>
<span>    ff_per_wopr <span class="op">=</span> <span class="va">total_ff</span> <span class="op">/</span> <span class="va">total_wopr</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">total_wopr</span><span class="op">)</span></span>
<span></span>
<span><span class="va">receivers_wopr_ff_context</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 225 x 4
   player_name total_wopr total_ff ff_per_wopr
   &lt;chr&gt;            &lt;dbl&gt;    &lt;dbl&gt;       &lt;dbl&gt;
 1 D.Moore           13.9    136.         9.76
 2 D.Adams           13.4    236.        17.6 
 3 T.Hill            12.4    222.        17.9 
 4 A.Brown           12.2    212.        17.4 
 5 J.Jefferson       11.9    241.        20.3 
 6 C.Lamb            11.8    195.        16.5 
 7 A.Cooper          11.8    168         14.2 
 8 D.Johnson         11.2     94.7        8.48
 9 D.London          10.9    107.         9.77
10 D.Metcalf         10.7    137.        12.7 
# i 215 more rows</code></pre>
</div>
</div>
<p>There are several insights evident in the results. Of the top <code>wopr</code> earners in the 2022 season. only Diontae Johnson scored fewer fantasy points than D.J. Moore (94.7 to 136). Given the relationship between <code>total_wopr</code> and <code>total_ff</code>, a lower <code>ff_per_wopr</code> is indicative of less stellar play. In this case, Moore maintained a large amount of both the team’s <code>target_share</code> and <code>air_yards_share</code>, but was not able to translate that into a higher amount of fantasy points (as evidenced by a lower <code>ff_per_wopr</code> score). On the other hand, Justin Jefferson’s <code>ff_per_wopr</code> score of 20.3 argues that he used his amount of <code>target_share</code> and <code>air_yards_share</code> to increase the amount of fantasy points he produced.</p>
<p>Based on the above examples, it is clear that the <code>load_player_stats()</code> function is useful when needing to aggregate statistics on a weekly or season-long basis. While this does allow for easy matching of official statistics, it does not provide the ability to add context to the findings. For example, we know that Patrick Mahomes had the highest adjusted pass yards per attempt during the 2018 regular season with 9.58. But, what if we wanted to explore that same metric but only on passes that took place on 3rd down with 10 or less yards to go?</p>
<p>Unfortunately, the <code>load_player_stats()</code> function does not provide ability to distill the statistics into specific situations. Because of this, we must turn to the <code>load_pbp()</code> function.</p>
</section></section><section id="using-load_pbp-to-add-context-to-statistics" class="level2" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="using-load_pbp-to-add-context-to-statistics">
<span class="header-section-number">3.2</span> Using <code>load_pbp()</code> to Add Context to Statistics</h2>
<p>Using the <code>load_pbp()</code> function is preferable when you are looking to add context to a player’s statistics, as the <code>load_player_stats()</code> function is, for all intents and purposes, aggregated statistics that limit your ability to find deeper meaning.</p>
<p>The <code>load_pbp()</code> function provides over 350 various metrics, as listed below:</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/pbp-data-ls_bf0a580d8d091b905e9e7bf7c70cee84">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pbp.data</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pbp.html">load_pbp</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="va">pbp.data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] "aborted_play"                        
  [2] "air_epa"                             
  [3] "air_wpa"                             
  [4] "air_yards"                           
  [5] "assist_tackle"                       
  [6] "assist_tackle_1_player_id"           
  [7] "assist_tackle_1_player_name"         
  [8] "assist_tackle_1_team"                
  [9] "assist_tackle_2_player_id"           
 [10] "assist_tackle_2_player_name"         
 [11] "assist_tackle_2_team"                
 [12] "assist_tackle_3_player_id"           
 [13] "assist_tackle_3_player_name"         
 [14] "assist_tackle_3_team"                
 [15] "assist_tackle_4_player_id"           
 [16] "assist_tackle_4_player_name"         
 [17] "assist_tackle_4_team"                
 [18] "away_coach"                          
 [19] "away_score"                          
 [20] "away_team"                           
 [21] "away_timeouts_remaining"             
 [22] "away_wp"                             
 [23] "away_wp_post"                        
 [24] "blocked_player_id"                   
 [25] "blocked_player_name"                 
 [26] "comp_air_epa"                        
 [27] "comp_air_wpa"                        
 [28] "comp_yac_epa"                        
 [29] "comp_yac_wpa"                        
 [30] "complete_pass"                       
 [31] "cp"                                  
 [32] "cpoe"                                
 [33] "def_wp"                              
 [34] "defensive_extra_point_attempt"       
 [35] "defensive_extra_point_conv"          
 [36] "defensive_two_point_attempt"         
 [37] "defensive_two_point_conv"            
 [38] "defteam"                             
 [39] "defteam_score"                       
 [40] "defteam_score_post"                  
 [41] "defteam_timeouts_remaining"          
 [42] "desc"                                
 [43] "div_game"                            
 [44] "down"                                
 [45] "drive"                               
 [46] "drive_end_transition"                
 [47] "drive_end_yard_line"                 
 [48] "drive_ended_with_score"              
 [49] "drive_first_downs"                   
 [50] "drive_game_clock_end"                
 [51] "drive_game_clock_start"              
 [52] "drive_inside20"                      
 [53] "drive_play_count"                    
 [54] "drive_play_id_ended"                 
 [55] "drive_play_id_started"               
 [56] "drive_quarter_end"                   
 [57] "drive_quarter_start"                 
 [58] "drive_real_start_time"               
 [59] "drive_start_transition"              
 [60] "drive_start_yard_line"               
 [61] "drive_time_of_possession"            
 [62] "drive_yards_penalized"               
 [63] "end_clock_time"                      
 [64] "end_yard_line"                       
 [65] "ep"                                  
 [66] "epa"                                 
 [67] "extra_point_attempt"                 
 [68] "extra_point_prob"                    
 [69] "extra_point_result"                  
 [70] "fantasy"                             
 [71] "fantasy_id"                          
 [72] "fantasy_player_id"                   
 [73] "fantasy_player_name"                 
 [74] "fg_prob"                             
 [75] "field_goal_attempt"                  
 [76] "field_goal_result"                   
 [77] "first_down"                          
 [78] "first_down_pass"                     
 [79] "first_down_penalty"                  
 [80] "first_down_rush"                     
 [81] "fixed_drive"                         
 [82] "fixed_drive_result"                  
 [83] "forced_fumble_player_1_player_id"    
 [84] "forced_fumble_player_1_player_name"  
 [85] "forced_fumble_player_1_team"         
 [86] "forced_fumble_player_2_player_id"    
 [87] "forced_fumble_player_2_player_name"  
 [88] "forced_fumble_player_2_team"         
 [89] "fourth_down_converted"               
 [90] "fourth_down_failed"                  
 [91] "fumble"                              
 [92] "fumble_forced"                       
 [93] "fumble_lost"                         
 [94] "fumble_not_forced"                   
 [95] "fumble_out_of_bounds"                
 [96] "fumble_recovery_1_player_id"         
 [97] "fumble_recovery_1_player_name"       
 [98] "fumble_recovery_1_team"              
 [99] "fumble_recovery_1_yards"             
[100] "fumble_recovery_2_player_id"         
[101] "fumble_recovery_2_player_name"       
[102] "fumble_recovery_2_team"              
[103] "fumble_recovery_2_yards"             
[104] "fumbled_1_player_id"                 
[105] "fumbled_1_player_name"               
[106] "fumbled_1_team"                      
[107] "fumbled_2_player_id"                 
[108] "fumbled_2_player_name"               
[109] "fumbled_2_team"                      
[110] "game_date"                           
[111] "game_half"                           
[112] "game_id"                             
[113] "game_seconds_remaining"              
[114] "game_stadium"                        
[115] "goal_to_go"                          
[116] "half_sack_1_player_id"               
[117] "half_sack_1_player_name"             
[118] "half_sack_2_player_id"               
[119] "half_sack_2_player_name"             
[120] "half_seconds_remaining"              
[121] "home_coach"                          
[122] "home_opening_kickoff"                
[123] "home_score"                          
[124] "home_team"                           
[125] "home_timeouts_remaining"             
[126] "home_wp"                             
[127] "home_wp_post"                        
[128] "id"                                  
[129] "incomplete_pass"                     
[130] "interception"                        
[131] "interception_player_id"              
[132] "interception_player_name"            
[133] "jersey_number"                       
[134] "kick_distance"                       
[135] "kicker_player_id"                    
[136] "kicker_player_name"                  
[137] "kickoff_attempt"                     
[138] "kickoff_downed"                      
[139] "kickoff_fair_catch"                  
[140] "kickoff_in_endzone"                  
[141] "kickoff_inside_twenty"               
[142] "kickoff_out_of_bounds"               
[143] "kickoff_returner_player_id"          
[144] "kickoff_returner_player_name"        
[145] "lateral_interception_player_id"      
[146] "lateral_interception_player_name"    
[147] "lateral_kickoff_returner_player_id"  
[148] "lateral_kickoff_returner_player_name"
[149] "lateral_punt_returner_player_id"     
[150] "lateral_punt_returner_player_name"   
[151] "lateral_receiver_player_id"          
[152] "lateral_receiver_player_name"        
[153] "lateral_receiving_yards"             
[154] "lateral_reception"                   
[155] "lateral_recovery"                    
[156] "lateral_return"                      
[157] "lateral_rush"                        
[158] "lateral_rusher_player_id"            
[159] "lateral_rusher_player_name"          
[160] "lateral_rushing_yards"               
[161] "lateral_sack_player_id"              
[162] "lateral_sack_player_name"            
[163] "location"                            
[164] "name"                                
[165] "nfl_api_id"                          
[166] "no_huddle"                           
[167] "no_score_prob"                       
[168] "old_game_id"                         
[169] "opp_fg_prob"                         
[170] "opp_safety_prob"                     
[171] "opp_td_prob"                         
[172] "order_sequence"                      
[173] "out_of_bounds"                       
[174] "own_kickoff_recovery"                
[175] "own_kickoff_recovery_player_id"      
[176] "own_kickoff_recovery_player_name"    
[177] "own_kickoff_recovery_td"             
[178] "pass"                                
[179] "pass_attempt"                        
[180] "pass_defense_1_player_id"            
[181] "pass_defense_1_player_name"          
[182] "pass_defense_2_player_id"            
[183] "pass_defense_2_player_name"          
[184] "pass_length"                         
[185] "pass_location"                       
[186] "pass_oe"                             
[187] "pass_touchdown"                      
[188] "passer"                              
[189] "passer_id"                           
[190] "passer_jersey_number"                
[191] "passer_player_id"                    
[192] "passer_player_name"                  
[193] "passing_yards"                       
[194] "penalty"                             
[195] "penalty_player_id"                   
[196] "penalty_player_name"                 
[197] "penalty_team"                        
[198] "penalty_type"                        
[199] "penalty_yards"                       
[200] "play"                                
[201] "play_clock"                          
[202] "play_deleted"                        
[203] "play_id"                             
[204] "play_type"                           
[205] "play_type_nfl"                       
[206] "posteam"                             
[207] "posteam_score"                       
[208] "posteam_score_post"                  
[209] "posteam_timeouts_remaining"          
[210] "posteam_type"                        
[211] "punt_attempt"                        
[212] "punt_blocked"                        
[213] "punt_downed"                         
[214] "punt_fair_catch"                     
[215] "punt_in_endzone"                     
[216] "punt_inside_twenty"                  
[217] "punt_out_of_bounds"                  
[218] "punt_returner_player_id"             
[219] "punt_returner_player_name"           
[220] "punter_player_id"                    
[221] "punter_player_name"                  
[222] "qb_dropback"                         
[223] "qb_epa"                              
[224] "qb_hit"                              
[225] "qb_hit_1_player_id"                  
[226] "qb_hit_1_player_name"                
[227] "qb_hit_2_player_id"                  
[228] "qb_hit_2_player_name"                
[229] "qb_kneel"                            
[230] "qb_scramble"                         
[231] "qb_spike"                            
[232] "qtr"                                 
[233] "quarter_end"                         
[234] "quarter_seconds_remaining"           
[235] "receiver"                            
[236] "receiver_id"                         
[237] "receiver_jersey_number"              
[238] "receiver_player_id"                  
[239] "receiver_player_name"                
[240] "receiving_yards"                     
[241] "replay_or_challenge"                 
[242] "replay_or_challenge_result"          
[243] "result"                              
[244] "return_team"                         
[245] "return_touchdown"                    
[246] "return_yards"                        
[247] "roof"                                
[248] "run_gap"                             
[249] "run_location"                        
[250] "rush"                                
[251] "rush_attempt"                        
[252] "rush_touchdown"                      
[253] "rusher"                              
[254] "rusher_id"                           
[255] "rusher_jersey_number"                
[256] "rusher_player_id"                    
[257] "rusher_player_name"                  
[258] "rushing_yards"                       
[259] "sack"                                
[260] "sack_player_id"                      
[261] "sack_player_name"                    
[262] "safety"                              
[263] "safety_player_id"                    
[264] "safety_player_name"                  
[265] "safety_prob"                         
[266] "score_differential"                  
[267] "score_differential_post"             
[268] "season"                              
[269] "season_type"                         
[270] "series"                              
[271] "series_result"                       
[272] "series_success"                      
[273] "shotgun"                             
[274] "side_of_field"                       
[275] "solo_tackle"                         
[276] "solo_tackle_1_player_id"             
[277] "solo_tackle_1_player_name"           
[278] "solo_tackle_1_team"                  
[279] "solo_tackle_2_player_id"             
[280] "solo_tackle_2_player_name"           
[281] "solo_tackle_2_team"                  
[282] "sp"                                  
[283] "special"                             
[284] "special_teams_play"                  
[285] "spread_line"                         
[286] "st_play_type"                        
[287] "stadium"                             
[288] "stadium_id"                          
[289] "start_time"                          
[290] "success"                             
[291] "surface"                             
[292] "tackle_for_loss_1_player_id"         
[293] "tackle_for_loss_1_player_name"       
[294] "tackle_for_loss_2_player_id"         
[295] "tackle_for_loss_2_player_name"       
[296] "tackle_with_assist"                  
[297] "tackle_with_assist_1_player_id"      
[298] "tackle_with_assist_1_player_name"    
[299] "tackle_with_assist_1_team"           
[300] "tackle_with_assist_2_player_id"      
[301] "tackle_with_assist_2_player_name"    
[302] "tackle_with_assist_2_team"           
[303] "tackled_for_loss"                    
[304] "td_player_id"                        
[305] "td_player_name"                      
[306] "td_prob"                             
[307] "td_team"                             
[308] "temp"                                
[309] "third_down_converted"                
[310] "third_down_failed"                   
[311] "time"                                
[312] "time_of_day"                         
[313] "timeout"                             
[314] "timeout_team"                        
[315] "total"                               
[316] "total_away_comp_air_epa"             
[317] "total_away_comp_air_wpa"             
[318] "total_away_comp_yac_epa"             
[319] "total_away_comp_yac_wpa"             
[320] "total_away_epa"                      
[321] "total_away_pass_epa"                 
[322] "total_away_pass_wpa"                 
[323] "total_away_raw_air_epa"              
[324] "total_away_raw_air_wpa"              
[325] "total_away_raw_yac_epa"              
[326] "total_away_raw_yac_wpa"              
[327] "total_away_rush_epa"                 
[328] "total_away_rush_wpa"                 
[329] "total_away_score"                    
[330] "total_home_comp_air_epa"             
[331] "total_home_comp_air_wpa"             
[332] "total_home_comp_yac_epa"             
[333] "total_home_comp_yac_wpa"             
[334] "total_home_epa"                      
[335] "total_home_pass_epa"                 
[336] "total_home_pass_wpa"                 
[337] "total_home_raw_air_epa"              
[338] "total_home_raw_air_wpa"              
[339] "total_home_raw_yac_epa"              
[340] "total_home_raw_yac_wpa"              
[341] "total_home_rush_epa"                 
[342] "total_home_rush_wpa"                 
[343] "total_home_score"                    
[344] "total_line"                          
[345] "touchback"                           
[346] "touchdown"                           
[347] "two_point_attempt"                   
[348] "two_point_conv_result"               
[349] "two_point_conversion_prob"           
[350] "vegas_home_wp"                       
[351] "vegas_home_wpa"                      
[352] "vegas_wp"                            
[353] "vegas_wpa"                           
[354] "weather"                             
[355] "week"                                
[356] "wind"                                
[357] "wp"                                  
[358] "wpa"                                 
[359] "xpass"                               
[360] "xyac_epa"                            
[361] "xyac_fd"                             
[362] "xyac_mean_yardage"                   
[363] "xyac_median_yardage"                 
[364] "xyac_success"                        
[365] "yac_epa"                             
[366] "yac_wpa"                             
[367] "yardline_100"                        
[368] "yards_after_catch"                   
[369] "yards_gained"                        
[370] "ydsnet"                              
[371] "ydstogo"                             
[372] "yrdln"                               </code></pre>
</div>
</div>
<p>The amount of information contained in the <code>nflverse</code> play-by-play data can be overwhelming. Luckily, the <code>nflreadr</code> website includes a searchable directory of all the variables with a brief description of what each one means. You can visit that here: <a href="https://nflreadr.nflverse.com/articles/dictionary_pbp.html">nflreadr Field Descriptions</a>.</p>
<p>We can recreate our examination of 2018 adjusted pass yards per attempt to just those passes on 3rd down with 10 or less yards to go by running the following code:</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/adjusted-yards-with-pbp_a6c93e0eaf1d062d0bdb77968c49d97f">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pbp</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pbp.html">load_pbp</a></span><span class="op">(</span><span class="fl">2018</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adjusted_yards</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">passer_player_name</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">down</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">ydstogo</span> <span class="op">&lt;=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">complete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">incomplete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">interception</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> </span>
<span>           <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">down</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    total_attempts <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    adj_yards <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">yards_gained</span><span class="op">)</span> <span class="op">+</span> <span class="fl">20</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">touchdown</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="fl">45</span> <span class="op">*</span> </span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">interception</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">total_attempts</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">total_attempts</span> <span class="op">&gt;=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">adj_yards</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adjusted_yards</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 32 x 3
   passer_player_name total_attempts adj_yards
   &lt;chr&gt;                       &lt;int&gt;     &lt;dbl&gt;
 1 A.Rodgers                      98     11.3 
 2 P.Mahomes                     102     10.3 
 3 R.Wilson                      104     10.3 
 4 E.Manning                     119      9.18
 5 M.Mariota                      79      8.43
 6 M.Ryan                        117      8.26
 7 J.Winston                      66      8.05
 8 D.Brees                        97      7.99
 9 D.Prescott                    104      7.87
10 J.Flacco                       74      7.84
# i 22 more rows</code></pre>
</div>
</div>
<p>Because the <code>load_pbp()</code> data is not pre-aggregated, we must do a bit of the work ourselves before we are able to achieve our answer. To start, we load the 2018 play-by-play data into a data frame titled <code>pbp</code> but using the <code>load_pbp()</code> function with the <code>season</code> argument set to “2018.” As well, we use the <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> function to make sure the data gathered into our <code>pbp</code> data frame is only the regular season statistics. Once the play-by-play is loaded, we create a data frame off of it titled <code>adjusted_yards</code> wherein we use <code>group_by()</code> to calculate the metric for each individual quarterback, then ensure that we are collecting the play-by-play data for only those plays that took place on 3rd down with ten or less yards to go.</p>
<p>We then use a second <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> to gather those plays where <code>complete_pass == 1</code> <em>or</em> <code>incomplete_pass == 1</code> <em>or</em> <code>interception == 1</code> <em>and</em> the <code>down</code> is not missing (which usually indicates a 2-point conversion attempt). As a result, each quarterback has an exact match to the number of complete passes, attempts, and interceptions as found in the official statistics of the season.</p>
<p>Despite leading the league in adjusted pass yard per attempt in 2018, Mahomes finished a whole yard behind Aaron Rodgers when exploring the same metric on 3rd down with 10 or less yards to go (and was tied for second place with Russel Wilson).</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Why is it necessary to use such a long list of specifications in the <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> function in order to match the official QB statistics found elsewhere?</p>
<p>That is a good question, especially since there are other variables within the play-by-play data that would seemingly return the correct results (such as <code>pass == 1</code> or <code>play_type == "pass"</code>. We can view the differences in all three methods by doing the following.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/passing-number-differences_75c9f466a01558d9dce48b139b296f30">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pbp</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pbp.html">load_pbp</a></span><span class="op">(</span><span class="fl">2018</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">complete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">incomplete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">interception</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span></span>
<span>           <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">down</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">passer_player_name</span> <span class="op">==</span> <span class="st">"P.Mahomes"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>total_attempts <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 x 1
  total_attempts
           &lt;int&gt;
1            580</code></pre>
</div>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pass_numbers</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">passer_player_name</span> <span class="op">==</span> <span class="st">"P.Mahomes"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    using_pass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pass</span> <span class="op">==</span> <span class="fl">1</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    using_playtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">play_type</span> <span class="op">==</span> <span class="st">"pass"</span><span class="op">)</span>,</span>
<span>    using_filter <span class="op">=</span> <span class="fl">580</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pass_numbers</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 x 3
  using_pass using_playtype using_filter
       &lt;int&gt;          &lt;int&gt;        &lt;dbl&gt;
1        606            606          580</code></pre>
</div>
</div>
<p>We know that Patrick Mahomes attempted 580 passes during the 2022 regular season. We can match that number exactly using the <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> method for <code>complete_pass</code>, <code>incomplete_pass</code>, <code>interception</code>, and removing plays with a missing <code>down</code> observation. When trying to replicate this number using either the <code>pass == 1</code> variable in the play-by-play data or <code>play_type == "pass"</code>, we get just over 20 more passes than expected.</p>
<p>The main reason for this is the inclusion of the <code>qb_spike</code>, <code>qb_scramble</code>, and <code>sack</code> variables. We can actually use the code above that was used to create the <code>pass_numbers</code> data frame, add an additional <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> to account for these, and get the correct number of passing attempts for each method.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/pass_numbers_correct_4fd7b9dde0cdefa045c31d8c77ca8744">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pass_numbers_correct</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">passer_player_name</span> <span class="op">==</span> <span class="st">"P.Mahomes"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">qb_spike</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">qb_scramble</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">sack</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    using_pass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pass</span> <span class="op">==</span> <span class="fl">1</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    using_playtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">play_type</span> <span class="op">==</span> <span class="st">"pass"</span><span class="op">)</span>,</span>
<span>    using_filter <span class="op">=</span> <span class="fl">580</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pass_numbers_correct</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 x 3
  using_pass using_playtype using_filter
       &lt;int&gt;          &lt;int&gt;        &lt;dbl&gt;
1        580            580          580</code></pre>
</div>
</div>
<p>By using <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> to remove any play that included a QB spike, a QB scramble, or a sack, we get 580 attempts when using both <code>pass == 1</code> and <code>play_type == "pass"</code> which replicates the official statistics from the 2018 season for Patrick Mahomes.</p>
<p><strong><em>What about the use of <code>passer</code> vs.&nbsp;<code>passer_player_name</code>?</em></strong></p>
<p>It is also important to remember that you will receive differing numbers based on your use of <code>passer</code> and <code>passer_player_name</code>. The <code>passer</code> variable is created internally by the <code>nflverse</code> system and is used to “mimic” the statistics without spikes, scrambles, or sacks in the data. The <code>passer_player_name</code> variable comes from the official statistics and inherently includes this information.</p>
<p>The following, with the first method using <code>group_by(passer)</code> and the second using <code>group_by(passer_player_name)</code> returns differing results.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/passer-vs-passer-player-name_aef9733f201a78dbacca5573bbd82c1d">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">passer_grouping</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">complete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">incomplete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">interception</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">down</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">passer</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>total_attempts <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">total_attempts</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">passer_player_grouping</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">complete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">incomplete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">interception</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">down</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">passer_player_name</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>total_attempts <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">total_attempts</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">passer_grouping</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 x 2
  passer           total_attempts
  &lt;chr&gt;                     &lt;int&gt;
1 B.Roethlisberger            672
2 A.Luck                      637
3 M.Ryan                      607
4 K.Cousins                   603
5 A.Rodgers                   595</code></pre>
</div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">passer_player_grouping</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 x 2
  passer_player_name total_attempts
  &lt;chr&gt;                       &lt;int&gt;
1 B.Roethlisberger              675
2 A.Luck                        639
3 M.Ryan                        608
4 K.Cousins                     606
5 A.Rodgers                     597</code></pre>
</div>
</div>
<p>When grouping by <code>passer</code>, we get a total attempts of 672 for Ben Roethlisberger. That number increases to 675 when grouping by <code>passer_player_name</code>. Again, this is because the <code>passer</code> variable is created by the <code>nflverse</code> and automatically removes spikes, scrambles, and sacks while <code>passer_player_name</code> includes all three.</p>
<p>We can run the following code to determine where the difference of three passing attempts is coming from between <code>passer</code> and <code>passer_player_name</code>.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/locating-attempt-difference_5af4d9e30946e8abf47f7ce4ae40140f">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">roethlisberger_difference</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">complete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">incomplete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">interception</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">down</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">passer_player_name</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>total_attempts <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>            spikes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">qb_spike</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            scramble <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">qb_scramble</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            sacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">sack</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">total_attempts</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">roethlisberger_difference</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 x 5
  passer_player_name total_attempts spikes scramble sacks
  &lt;chr&gt;                       &lt;int&gt;  &lt;int&gt;    &lt;int&gt; &lt;int&gt;
1 B.Roethlisberger              675      3        0     0
2 A.Luck                        639      2        0     0
3 M.Ryan                        608      1        0     0
4 K.Cousins                     606      3        0     0
5 A.Rodgers                     597      2        0     0</code></pre>
</div>
</div>
<p>In the case of Roethlisberger, the three pass attempt difference was the result of the <code>passer_player_name</code> grouping including three QB spikes in the data. <strong>Aside from when attempting to replicate the official statistics, it is better to use just <code>passer</code> as it removes those instances where a QB spike, scramble, or sack my skew the results of your data.</strong></p>
</div>
</div>
<p>To continue working with <code>load_pbp()</code> data, let’s create a metric that examines a QB’s aggressiveness on 3rd down passing attempts. The metric is designed to determine which QBs in the NFL are most aggressive in 3rd down situations by gauging how often they throw the ball to, or pass, the first down line. It is an interesting metric to explore as, just like many metrics in the NFL, not all air yards are created equal. For example, eight air yards on 1st and 10 are less valuable than the same eight air yards on 3rd and 5.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/3rd-down-aggressive_4009903ef9f217c8eda2404483a57c20">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pbp</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pbp.html">load_pbp</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span></span>
<span></span>
<span><span class="va">aggressiveness</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">complete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">incomplete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">interception</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span></span>
<span>           <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">down</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">down</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">ydstogo</span> <span class="op">&gt;=</span> <span class="fl">5</span> <span class="op">&amp;</span> <span class="va">ydstogo</span> <span class="op">&lt;=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">passer</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    team <span class="op">=</span> <span class="fu">last</span><span class="op">(</span><span class="va">posteam</span><span class="op">)</span>,</span>
<span>    total <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    aggressive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">air_yards</span> <span class="op">&gt;=</span> <span class="va">ydstogo</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    percentage <span class="op">=</span> <span class="va">aggressive</span> <span class="op">/</span> <span class="va">total</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">total</span> <span class="op">&gt;=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">percentage</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">aggressiveness</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 x 5
   passer    team  total aggressive percentage
   &lt;chr&gt;     &lt;chr&gt; &lt;int&gt;      &lt;int&gt;      &lt;dbl&gt;
 1 P.Mahomes KC       75         55      0.733
 2 K.Pickett PIT      54         36      0.667
 3 M.Jones   NE       56         36      0.643
 4 D.Carr    LV       74         47      0.635
 5 R.Wilson  DEN      63         40      0.635
 6 G.Smith   SEA      65         41      0.631
 7 A.Dalton  NO       55         34      0.618
 8 J.Hurts   PHI      65         40      0.615
 9 K.Cousins MIN      84         51      0.607
10 J.Allen   BUF      61         35      0.574</code></pre>
</div>
</div>
<p>Following our above example, we use <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> on the play-by-play data to calculate the total number of attempts for each quarterback on 3rd down when there were between 5 and 10 yards to go for a first down. Because we want to make sure we are not gathering attempts with spikes, scrambles, etc., we use <code>passer</code> in the <code>group_by()</code> function and then calculate the <code>total</code> attempts for each quarterback. After, we find the total number of times each quarterback was <code>aggressive</code> by finding the sum of attempts where the <code>air_yards</code> of the pass were greater than or equal to the required <code>ydstogo</code>. The two numbers are then divided (<code>aggressive</code> / <code>total</code>) to get each quarterback’s percentage.</p>
<p>As you can see in the output of <code>aggressiveness</code>, Mahomes was the most aggressive quarterback in 3rd down passing situation in the 2022 season, passing to, or beyond, the line of gain just over 73% of the time.</p>
<p>One item to consider, however, is the concept of “garbage time.” Are the above results, perhaps, skewed by including quarterbacks that were forced to work the ball downfield while attempting a game-winning drive?</p>
<section id="qb-aggressiveness-filtering-for-garbage-time" class="level4" data-number="3.2.0.1"><h4 data-number="3.2.0.1" class="anchored" data-anchor-id="qb-aggressiveness-filtering-for-garbage-time">
<span class="header-section-number">3.2.0.1</span> QB Aggressiveness: Filtering for “Garbage Time?”</h4>
<p>To examine the impact of “garbage time” statistics, we can add an additional <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> that removes those plays that take place within the last 2-minutes of the half and when the probability of winning for either team is over 95% or under 5%.</p>
<p>Let’s add the “garbage time” filter to the code we’ve already prepared:</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/qb-aggressiveness-garage-time_b0d62e7520cbf86a5d2a90b78c1f2728">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">aggressiveness_garbage</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">complete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">incomplete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">interception</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span></span>
<span>           <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">down</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">down</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">ydstogo</span> <span class="op">&gt;=</span> <span class="fl">5</span> <span class="op">&amp;</span> <span class="va">ydstogo</span> <span class="op">&lt;=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">wp</span> <span class="op">&gt;</span> <span class="fl">.05</span> <span class="op">&amp;</span> <span class="va">wp</span> <span class="op">&lt;</span> <span class="fl">.95</span> <span class="op">&amp;</span> <span class="va">half_seconds_remaining</span> <span class="op">&gt;</span> <span class="fl">120</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">passer</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    team <span class="op">=</span> <span class="fu">last</span><span class="op">(</span><span class="va">posteam</span><span class="op">)</span>,</span>
<span>    total <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    aggressive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">air_yards</span> <span class="op">&gt;=</span> <span class="va">ydstogo</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    percentage <span class="op">=</span> <span class="va">aggressive</span> <span class="op">/</span> <span class="va">total</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">total</span> <span class="op">&gt;=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">percentage</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">aggressiveness_garbage</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 x 5
   passer     team  total aggressive percentage
   &lt;chr&gt;      &lt;chr&gt; &lt;int&gt;      &lt;int&gt;      &lt;dbl&gt;
 1 P.Mahomes  KC       67         48      0.716
 2 K.Cousins  MIN      63         41      0.651
 3 G.Smith    SEA      50         32      0.64 
 4 D.Carr     LV       61         38      0.623
 5 D.Prescott DAL      52         28      0.538
 6 J.Herbert  LAC      71         38      0.535
 7 J.Burrow   CIN      67         35      0.522
 8 T.Lawrence JAX      69         35      0.507
 9 T.Brady    TB       70         35      0.5  
10 A.Rodgers  GB       53         26      0.491</code></pre>
</div>
</div>
<p>We are now using the same code, but have included three new items to the <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code>. First, we are stipulating that, aside from the down and distance inclusion, we only want those plays that occurred when the offense’s win probability (the <code>wp</code> variable) was between 5% and 95%, as well as ensuring that the plays did not happen after the two-minute warning of either half.</p>
<p>The decision on range of the win probability numbers is very much a personal preference. When <code>nflfastR</code> was first released, analyst often used a 20-80% range for the win probability cutoff point. However, Sebastian Carl - one of the creators of the <code>nflverse</code> explained in the package’s Discord:</p>
<blockquote class="blockquote">
<div class="blockquote" style="color: #373a3c">
<p>Sebastian Carl: “I am generally very conservative with filtering plays using wp. Especially the vegas wp model can reach &gt;85% probs early in the game because it incorporates market lines. I never understood the 20% &lt;= wp &lt;= 80%”garbage time” filter. This is removing a ton of plays. My general advice is a lower boundary of something around 5% (i.e., 5% &lt;= wp &lt;= 95%).</p>
</div>
</blockquote>
<p>Ben Baldwin followed up on Carl’s thoughts:</p>
<blockquote class="blockquote">
<div class="blockquote" style="color: #373a3c">
<p>Ben Baldwin: “agree with this. 20-80% should only be used as a filter for looking at how run-heavy a team is (because outside of this range is when teams change behavior a lot). and possibly how teams behave on 4th downs. but not for team or player performance.”</p>
</div>
</blockquote>
<p>Based on that advice, I typically stick to the 5-95% range when filtering for win probability in the <code>nflverse</code> play-by-play data. And, in this case, it did have an impact. In fact, when accounting for “garbage time,” Kenny Pickett went from being the second most aggressive QB in the league to not even being in the top ten. Conversely, Kirk Cousin went from being the ninth most aggressive quarterback to the second when accounting for win probability and the time left in the half.</p>
<p>That said, I more often than not do not concern myself with removing “garbage time” statistics. Despite the robust amount of data provided by the <code>nflverse</code> play-by-play function, the information still lacks great amount of granularity and, because of this, I believe removing “garbage time” plays often does more harm than good in the data analysis process.</p>
</section></section><section id="more-examples-using-load_pbp-data" class="level2" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="more-examples-using-load_pbp-data">
<span class="header-section-number">3.3</span> More Examples Using <code>load_pbp()</code> Data</h2>
<section id="qb-air-yards-epa-by-down" class="level3" data-number="3.3.1"><h3 data-number="3.3.1" class="anchored" data-anchor-id="qb-air-yards-epa-by-down">
<span class="header-section-number">3.3.1</span> QB Air Yards EPA by Down</h3>
<p>To continue working with quarterback information using the <code>load_pbp()</code> function, we can explore each quarterback’s air yards EPA for 1st, 2nd, and 3rd down.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/qb-mean-ayepa-down_b7d8969356d9de4ba8b5582198ea8817">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pbp</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pbp.html">load_pbp</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">qb_ay_by_down</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">complete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">incomplete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">interception</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span></span>
<span>           <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">down</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">down</span> <span class="op">&lt;=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">passer</span>, <span class="va">down</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    attempts <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    team <span class="op">=</span> <span class="fu">last</span><span class="op">(</span><span class="va">posteam</span><span class="op">)</span>,</span>
<span>    mean_airepa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">air_epa</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">attempts</span> <span class="op">&gt;=</span> <span class="fl">80</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">mean_airepa</span><span class="op">)</span></span>
<span></span>
<span><span class="va">qb_ay_by_down</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Josh Allen, Dak Prescott, and Tua Tagovailoa were all outstanding on 3rd down during the 2022 season, all recording over 1.00 in mean air yards EPA.</p>
</section><section id="measuring-impact-of-offensive-line" class="level3" data-number="3.3.2"><h3 data-number="3.3.2" class="anchored" data-anchor-id="measuring-impact-of-offensive-line">
<span class="header-section-number">3.3.2</span> Measuring Impact of Offensive Line</h3>
<p>Brian Burke - prior to moving to ESPN - used to host his own blog where he showcased his analytics work. In November of 2014, he wrote a post that detailed his process in determining how to value an offensive line’s performance over the course of an NFL season.</p>
<p>The process of making such a valuation is understandably difficult as, as Burke pointed out, an offensive line’s performance on the field is often characterized by the overall absence of stats. The less sacks, short yardage plays, tackles for loss, and quarterback scrambles - for example - the better. But how can the performance of an offensive line be quantified based on statistics that are absent?</p>
<p>To do so, Burke devised a rather ingenious method that is simple at its core: to measure the value of an offensive line’s play, we must determine the impact in which the opposing defensive line had on the game.</p>
<p>In his 2014 work on the topic, Burke used quarterback sacks, tackles for losses, short gains, tipped passes, and quarterback hits to provide a quantifiable valuation to a defensive line to then calculate the opposing valuation of the offensive line. Building upon this philosophy, we can build the same sort of study using the publicly available data in the <code>nflverse</code> play-by-play data by first using the following standard metrics:</p>
<ol type="1">
<li>sacks</li>
<li>QB hits</li>
<li>tackles for loss</li>
<li>yards gained less than/equal to 2</li>
<li>forcing a QB scramble</li>
</ol>
<p>To add more context, we can also create two new variables in the data that dictate whether a <code>qb_hit</code> and <code>incomplete_pass</code> are present in the same play, and the same for <code>qb_hit</code> and <code>interception</code>.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/oline-impact-start_72656e2b2c4995ac6223e4c04eeed76a">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pbp</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pbp.html">load_pbp</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>qbh_inc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">qb_hit</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">incomplete_pass</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span>,</span>
<span>         qb_int <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">qb_hit</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">interception</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pitt_plays</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">==</span> <span class="st">"PIT"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">week</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    total_plays <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">play_type</span> <span class="op">==</span> <span class="st">"run"</span> <span class="op">|</span></span>
<span>                        <span class="va">play_type</span> <span class="op">==</span> <span class="st">"pass"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pitt_line_value</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">sack</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">tackled_for_loss</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">yards_gained</span> <span class="op">&lt;=</span> <span class="fl">2</span> <span class="op">|</span></span>
<span>           <span class="va">qb_scramble</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">qb_hit</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">qbh_inc</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">qb_int</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">==</span> <span class="st">"PIT"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">posteam</span>, <span class="va">week</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">pitt_plays</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"week"</span> <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>opponent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">defteam</span><span class="op">)</span>,</span>
<span>            sum_wpa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">wpa</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            avg_wpa <span class="op">=</span> <span class="op">(</span><span class="va">sum_wpa</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">total_plays</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, as Burke pointed out in his initial study of the topic, calculating the number for just Pittsburgh, as above, does not provide enough information to draw a meaningful conclusion because even the most elite offensive lines in the NFL cannot avoid negative-pointed plays. In order to build this assumption into the data, we can gather the same information as above, but for the entire NFL minus the Steelers, and then calculate the difference in the Steelers’ weekly WPA to the league-wide average WPA.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/adding-league-wide-epa_77eb818746d5e8d5a8c4662fcc81cb95">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nfl_plays</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">!=</span> <span class="st">"PIT"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">week</span>, <span class="va">posteam</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>total_plays <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">play_type</span> <span class="op">==</span> <span class="st">"run"</span> <span class="op">|</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"pass"</span>,</span>
<span>                              na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nfl_line_value</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">!=</span> <span class="st">"PIT"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">sack</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">tackled_for_loss</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">yards_gained</span> <span class="op">&lt;=</span> <span class="fl">2</span> <span class="op">|</span></span>
<span>           <span class="va">qb_scramble</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">qb_hit</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">qbh_inc</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span></span>
<span>           <span class="va">qb_int</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">nfl_plays</span>,</span>
<span>            by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"posteam"</span> <span class="op">=</span> <span class="st">"posteam"</span>, <span class="st">"week"</span> <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">week</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nfl_weekly_plays <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">total_plays</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>nfl_sum_wpa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">wpa</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            nfl_avg_wpa <span class="op">=</span> <span class="op">(</span><span class="va">nfl_sum_wpa</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">nfl_weekly_plays</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now merge the NFL data back into the Steelers data to conduct the final calculation.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/add-nfl-to-pitt_a6f727d3f7cb25c96da17827937b1b4e">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pitt_line_value</span> <span class="op">&lt;-</span> <span class="va">pitt_line_value</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">nfl_line_value</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"week"</span> <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pitt_line_value</span> <span class="op">&lt;-</span> <span class="va">pitt_line_value</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>final_value <span class="op">=</span> <span class="va">avg_wpa</span> <span class="op">-</span> <span class="va">nfl_avg_wpa</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">week</span>, <span class="va">opponent</span>, <span class="va">final_value</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pitt_line_value</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">17</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The output provides a quantitative value of the Steelers’ offensive line performance over the course of the season in the <code>final_value</code> column. We’ve structured the data so that we can make the argument that the Steelers’ offensive line, in week 1, provided 1.55% more WPA than the rest of the NFL. In week 11, against New Orleans, the offensive line added a 1.11% chance of winning the game compared to all the other offensive line performances that specific week.</p>
<p>Conversely, negative numbers indicate that the play of the offensive line took away that percentage amount towards the probability of winning.</p>
<p>Unsurprisingly, the numbers across the board for the Steelers’ offensive line remain small, indicated that the group’s performance provided little to no help in earning victories for Pittsburgh.</p>
</section></section><section id="retrieving-working-with-data-for-multiple-seasons" class="level2" data-number="3.4"><h2 data-number="3.4" class="anchored" data-anchor-id="retrieving-working-with-data-for-multiple-seasons">
<span class="header-section-number">3.4</span> Retrieving &amp; Working With Data for Multiple Seasons</h2>
<p>In the case of both <code>load_pbp()</code> and <code>load_player_stats()</code>, it is possible to load data over multiple seasons.</p>
<p>In our above example calculating average air yard per attempt, it is important to note that Russell Wilson’s league-leading average of 9.89 air yards per attempt is calculated using <em>all</em> passing attempts, meaning pass attempts that were both complete and incomplete.</p>
<p>In our first example of working with data across multiple seasons, let’s examine average air yards for only completed passes. To begin, we will retrieve the play-by-play data for the last five seasons:</p>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ay_five_years</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pbp.html">load_pbp</a></span><span class="op">(</span><span class="fl">2017</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To retrieve multiple seasons of data, a colon <code>:</code> is placed between the years that you want. When you run the code, <code>nflreadr</code> will output the data to include the play-by-play data starting with the oldest season (in this case, the 2017 NFL season).</p>
<p>Once you have the data collected, we can run code that looks quite similar to our code above that explored 2021’s air yards per attempt leaders using <code>load_player_stats()</code>. In this case, however, we are including an additional <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> to gather those passing attempts that resulted <em>only</em> in complete passes:</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/avg-ay-5-results_8de140a679a1ab86282baa33fbe44d9e">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">average_airyards</span> <span class="op">&lt;-</span> <span class="va">ay_five_years</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">passer_id</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span> <span class="op">&amp;</span> <span class="va">complete_pass</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>player <span class="op">=</span> <span class="fu">first</span><span class="op">(</span><span class="va">passer_player_name</span><span class="op">)</span>,</span>
<span>            completions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">complete_pass</span><span class="op">)</span>,</span>
<span>            air.yards <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">air_yards</span><span class="op">)</span>,</span>
<span>            average <span class="op">=</span> <span class="va">air.yards</span> <span class="op">/</span> <span class="va">completions</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">completions</span> <span class="op">&gt;=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">average</span><span class="op">)</span></span>
<span></span>
<span><span class="va">average_airyards</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 28 x 5
   passer_id  player      completions air.yards average
   &lt;chr&gt;      &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
 1 00-0031503 J.Winston          1081      8830    8.17
 2 00-0033537 D.Watson           1285      9019    7.02
 3 00-0034857 J.Allen            1604     10912    6.80
 4 00-0029263 R.Wilson           1895     12742    6.72
 5 00-0034796 L.Jackson          1055      7046    6.68
 6 00-0026143 M.Ryan             2263     14694    6.49
 7 00-0033077 D.Prescott         1874     12105    6.46
 8 00-0034855 B.Mayfield         1386      8889    6.41
 9 00-0029701 R.Tannehill        1261      8043    6.38
10 00-0026498 M.Stafford         1874     11763    6.28
# i 18 more rows</code></pre>
</div>
</div>
<p>Of those QBs with at least 1,000 complete passes since the 2017 season, Jameis Winston has the highest average air yards per complete pass at 8.17.</p>
</section><section id="working-with-the-various-nflreadr-functions" class="level2" data-number="3.5"><h2 data-number="3.5" class="anchored" data-anchor-id="working-with-the-various-nflreadr-functions">
<span class="header-section-number">3.5</span> Working with the Various <code>nflreadr</code> Functions</h2>
<p>The <code>nflreadr</code> package comes with a multitude of “under the hood” functions designed to provide you with supplemental data, items for data visualization, and utilities for efficiently collecting and storing the data on your system. You can view the entire list of these options using the <code>ls</code> to output all the objects in the package.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/list-of-nfl-readr-functions_29c95f0e122f8059b9c944789881cff2">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="st">"package:nflreadr"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "clean_homeaway"               "clean_player_names"          
 [3] "clean_team_abbrs"             "clear_cache"                 
 [5] "csv_from_url"                 "dictionary_combine"          
 [7] "dictionary_contracts"         "dictionary_depth_charts"     
 [9] "dictionary_draft_picks"       "dictionary_espn_qbr"         
[11] "dictionary_ff_opportunity"    "dictionary_ff_playerids"     
[13] "dictionary_ff_rankings"       "dictionary_injuries"         
[15] "dictionary_nextgen_stats"     "dictionary_participation"    
[17] "dictionary_pbp"               "dictionary_pfr_passing"      
[19] "dictionary_player_stats"      "dictionary_rosters"          
[21] "dictionary_schedules"         "dictionary_snap_counts"      
[23] "dictionary_trades"            "ffverse_sitrep"              
[25] "get_current_season"           "get_current_week"            
[27] "get_latest_season"            "join_coalesce"               
[29] "load_combine"                 "load_contracts"              
[31] "load_depth_charts"            "load_draft_picks"            
[33] "load_espn_qbr"                "load_ff_opportunity"         
[35] "load_ff_playerids"            "load_ff_rankings"            
[37] "load_from_url"                "load_injuries"               
[39] "load_nextgen_stats"           "load_officials"              
[41] "load_participation"           "load_pbp"                    
[43] "load_pfr_advstats"            "load_pfr_passing"            
[45] "load_player_stats"            "load_players"                
[47] "load_rosters"                 "load_rosters_weekly"         
[49] "load_schedules"               "load_snap_counts"            
[51] "load_teams"                   "load_trades"                 
[53] "most_recent_season"           "nflverse_download"           
[55] "nflverse_game_id"             "nflverse_releases"           
[57] "nflverse_sitrep"              "parquet_from_url"            
[59] "player_name_mapping"          "progressively"               
[61] "qs_from_url"                  "raw_from_url"                
[63] "rbindlist_with_attrs"         "rds_from_url"                
[65] "team_abbr_mapping"            "team_abbr_mapping_norelocate"</code></pre>
</div>
</div>
<p>Going forward in this chapter, we will be exploring specific use cases for the functions provided by <code>nflreadr</code> - but not all of them. For example, the <code>dictionary_</code> functions can more easily be used directly on the <code>nflreadr</code> website where the package’s maintainers keep a copy of each. Many, like the dictionary for play-by-play data, includes a search feature to allow you to quickly find how the variables you are looking for is provided in the column name. Others, like the <code>clear_cache()</code> function is used only when you want to wipe any memoized data stored by <code>nflreadr</code> - often needed if you are troubleshooting a pesky error message - or <code>join_coalesce()</code> which is an experimental function that is only used internally to help build player IDs into the data. The <code>load_pbp()</code> and <code>load_player_stats()</code> function will also not be covered here, as the first portion of this chapter explored the use of both in great detail. We will briefly discuss the use of <code>load_players()</code> and <code>load_rosters()</code> but a more detailed discussion of each is provided in Chapter 4: Data Visualization with NFL Analytics. The remaining functions will be presented in the order provided on the <a href="https://nflreadr.nflverse.com/reference/index.html"><code>nflreadr</code> function reference website.</a></p>
<section id="the-load_participation-function" class="level3" data-number="3.5.1"><h3 data-number="3.5.1" class="anchored" data-anchor-id="the-load_participation-function">
<span class="header-section-number">3.5.1</span> The <code>load_participation()</code> Function</h3>
<p>The <code>load_participation()</code> function allows us to create a data frame of player participation data dating back to 2016 with an option to infuse that information into the existing <code>nflreadr</code> play-by-play data. The resulting data frame, when not including play-by-play data, includes information pertaining to: the individual game ID, the play ID, the possession team, what formation the offense was in, the layout of the offensive personnel, how many defenders were in the box, the defensive personnel, the number of rushers on pass players, and the unique ID number for each player on the field for that specific play.</p>
<p>Despite the <code>load_participation()</code> function being one of the newest editions to the <code>nflreadr</code> package, it is already being used to create contextual analysis regarding a team’s use of its players out out formations. For example, <a href="https://twitter.com/josephjefe">Joseph Hefner</a> uses the data to create tables (built with the <code>gt</code> and <code>gtExtras</code> packages) that calculates not only each player’s rate of usage out of different personnel packages, but how the team’s EPA per play and pass rate fluctuate with each. In the spirit of R’s open-source nature, he also created a <a href="https://www.jefeshandiwork.com/shiny/team-formations">Team Formation ShinyApp</a> that allows anybody to explore the data and output the results in .png format.</p>
<p></p>
<div id="tweet-39875"></div>
<script>tweet={"url":"https:\/\/twitter.com\/josephjefe\/status\/1621217561437409280","author_name":"Joseph Hefner","author_url":"https:\/\/twitter.com\/josephjefe","html":"\u003Cblockquote class=\"twitter-tweet\" align=\"center\"\u003E\u003Cp lang=\"en\" dir=\"ltr\"\u003EFormations from KC vs CIN! Chiefs offense first. Our 11 personnel was very not great. Probably due to all the attrition. But the other formations were pretty spectacular. Look at that 3TE 2WR set!!! Reid is a wizard. \u003Ca href=\"https:\/\/twitter.com\/hashtag\/nflverse?src=hash&amp;ref_src=twsrc%5Etfw\"\u003E#nflverse\u003C\/a\u003E \u003Ca href=\"https:\/\/twitter.com\/hashtag\/rstats?src=hash&amp;ref_src=twsrc%5Etfw\"\u003E#rstats\u003C\/a\u003E \u003Ca href=\"https:\/\/t.co\/UR87Wdu0mG\"\u003Epic.twitter.com\/UR87Wdu0mG\u003C\/a\u003E\u003C\/p\u003E&mdash; Joseph Hefner (@josephjefe) \u003Ca href=\"https:\/\/twitter.com\/josephjefe\/status\/1621217561437409280?ref_src=twsrc%5Etfw\"\u003EFebruary 2, 2023\u003C\/a\u003E\u003C\/blockquote\u003E\n\u003Cscript async src=\"https:\/\/platform.twitter.com\/widgets.js\" charset=\"utf-8\"\u003E\u003C\/script\u003E\n\n","width":550,"height":null,"type":"rich","cache_age":"3153600000","provider_name":"Twitter","provider_url":"https:\/\/twitter.com","version":"1.0"};document.getElementById("tweet-39875").innerHTML = tweet["html"];</script><p>To build a data frame of 2022 participation data, that includes complete play-by-play, you must pass both the <code>season</code> and <code>include_pbp</code> argument with the <code>load_participation()</code> function.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/loading-2022-participation_5d41a6f4f225480c33ff701797b9f2f8">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">participation</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_participation.html">load_participation</a></span><span class="op">(</span>season <span class="op">=</span> <span class="fl">2022</span>, include_pbp <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">participation</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 49,969 x 383
   nflverse_game_id play_id possession_team offense_formation
   &lt;chr&gt;              &lt;int&gt; &lt;chr&gt;           &lt;chr&gt;            
 1 2022_01_BAL_NYJ        1 ""              &lt;NA&gt;             
 2 2022_01_BAL_NYJ       43 "BAL"           &lt;NA&gt;             
 3 2022_01_BAL_NYJ       68 "NYJ"           SINGLEBACK       
 4 2022_01_BAL_NYJ       89 "NYJ"           SHOTGUN          
 5 2022_01_BAL_NYJ      115 "NYJ"           SINGLEBACK       
 6 2022_01_BAL_NYJ      136 "NYJ"           SHOTGUN          
 7 2022_01_BAL_NYJ      172 "NYJ"           &lt;NA&gt;             
 8 2022_01_BAL_NYJ      202 "BAL"           SINGLEBACK       
 9 2022_01_BAL_NYJ      230 "BAL"           SHOTGUN          
10 2022_01_BAL_NYJ      254 "BAL"           EMPTY            
# i 49,959 more rows
# i 379 more variables: offense_personnel &lt;chr&gt;, ...</code></pre>
</div>
</div>
<p>Rather than exploring the data at the league-level, let’s take a micro-approach to the participation data and examine the the 2022 Pittsburgh Steelers. It is important to note that the participation data, as gathered using the <code>load_participation()</code> function, is not fully prepped for immediate analysis as the <code>players_on_play</code>, <code>offense_players</code>, and <code>defense_players</code> information (which contains the unique player identification numbers) are separated by a delimiter (in this case, a semicolon) in what are called “concatenated strings” or “delimited strings.” While this is a compact way to store the values in the core data frame, it does require us to clean the information through the “splitting” or “tokenizing” process. As you will see in the below code, we are going to place the unique identifiers into separate rows, based on formation, by utilizing the <code>separate_rows()</code> function in <code>tidyr</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you use <code>load_participation()</code> but set <code>include_pbp = FALSE</code> it is important to remember that the <code>posteam</code> variable that is part of the play-by-play data will not exist. Instead, the offensive team is indicated by the <code>possession_team</code> column.</p>
<p>If you gather the participation data <em>with</em> play-by-play information, you can use either <code>possession_team</code> or <code>posteam</code> for any filtering.</p>
<p>The same is not true when looking at defensive participation data. A defensive team variable is not provided without including the play-by-play in the data. Once set to <code>TRUE</code>, the defensive team is housed under the typical <code>defteam</code> column.</p>
</div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/prepping-participation-data_141c4f96d648d79292256f225293db08">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">participation_split</span> <span class="op">&lt;-</span> <span class="va">participation</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">offense_formation</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">==</span> <span class="st">"PIT"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_rows.html">separate_rows</a></span><span class="op">(</span><span class="va">offense_players</span>, sep <span class="op">=</span> <span class="st">";"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">offense_personnel</span>, <span class="va">offense_players</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>total <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">participation_split</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 157 x 3
   offense_personnel offense_players total
   &lt;chr&gt;             &lt;chr&gt;           &lt;int&gt;
 1 1 RB, 1 TE, 3 WR  00-0032897          3
 2 1 RB, 1 TE, 3 WR  00-0033869        262
 3 1 RB, 1 TE, 3 WR  00-0034142         37
 4 1 RB, 1 TE, 3 WR  00-0034347        781
 5 1 RB, 1 TE, 3 WR  00-0034768        781
 6 1 RB, 1 TE, 3 WR  00-0034785        744
 7 1 RB, 1 TE, 3 WR  00-0034928        235
 8 1 RB, 1 TE, 3 WR  00-0035216        745
 9 1 RB, 1 TE, 3 WR  00-0035217         25
10 1 RB, 1 TE, 3 WR  00-0035222        258
# i 147 more rows</code></pre>
</div>
</div>
<p>We are doing quite a few things in the above example:</p>
<ol type="1">
<li>
<strong>Those rows where the is an ‘NA’ value for <code>offense_formation</code></strong> <strong>are removed.</strong> The participation data includes information for kickoffs, extra points, field goals, punts, QB kneels, no plays, and more. It is possible to remove items using <code>play_type == "run" | play_type == "pass"</code> but such an approach, if done with the Steelers, results in one fake punt being included in the data (as the <code>play_type</code> was listed as “run”). If you wish to include plays such as fake punts, you do so by filtering for only specific play types.</li>
<li>
<strong>Only those rows that includes ‘PIT’ as the <code>posteam</code></strong> <strong>are included.</strong>
</li>
<li>
<strong>The <code>separate_rows()</code></strong> <strong>function from <code>tidyr</code></strong> <strong>is used to conduct the splitting of the concatenated players identifiers in the <code>offense_players</code></strong> <strong>column</strong>. The <code>separate_rows()</code> function needs just two arguments to complete the process - the column name and the delimiter (provided in the argument as <code>sep =</code>).</li>
<li>
<strong>The newly split data is then grouped by <code>offense_personnel</code></strong> <strong>and <code>offense_players</code></strong> <strong>in order to calculate the number of times each specific ID was associated with personnel package</strong>. The resulting data frame lists the offense formation type for each player that participated in it, along with the player’s respective participation count.</li>
</ol>
<p>As is, the <code>load_participation()</code> data does not include any way to further identify players outside of the unique players IDs. Because of this, it is necessary to use the <code>load_rosters()</code> function to include this information (this process is included below in the <code>load_rosters()</code> section).</p>
</section><section id="the-load_rosters-and-load_rosters_weekly-functions" class="level3" data-number="3.5.2"><h3 data-number="3.5.2" class="anchored" data-anchor-id="the-load_rosters-and-load_rosters_weekly-functions">
<span class="header-section-number">3.5.2</span> The <code>load_rosters()</code> and <code>load_rosters_weekly()</code> Functions</h3>
<p>The <code>load_rosters()</code> function houses a multitude of useful tools for use in the <code>nflverse</code>. With player information dating back to 1920, <code>load_rosters()</code> will provide you with basic demographic information about each player in the NFL such as their name, birth date, height, weight, the college and high school they attended, and items regarding primary position and depth chart position.</p>
<p>Importantly, <code>load_rosters()</code> also provides the unique identifier for each player over nine different sources: the <code>gsis_id</code> (which is the core ID used in <code>nflverse</code> data), <code>sleeper_id</code>, <code>espn_id</code>, <code>yahoo_id</code>, <code>rotowire_id</code>, <code>pff_id</code>, <code>fantasy_data_id</code>, <code>sportradar_id</code>, and <code>pfr_id</code>. The different IDs become extremely useful when using data collected from outside the <code>nflverse</code>, or when combining data from two outside sources, as matching the information can be done by matching the various IDs as needed. As well, as outlined in Chapter 4: Data Visualization with NFL Analytics, the URLs for player headshots are included in <code>load_rosters()</code> data.</p>
<p>Let’s return to our <code>participation_split</code> data frame that we just built while working with the <code>load_participation()</code> function. While the data is formatted and prepared for analysis, there is no information that allows for easy identification of each player (aside from unique IDs, which is not helpful). To correct this, we can bring in the 2022 Pittsburgh Steelers roster information.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/loading-rosters-for-partic_8b97e9f48dbda450a67ebe80c2e3a4b7">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rosters</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_rosters.html">load_rosters</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The only argument you must provide the <code>load_rosters()</code> function is the years in which you want to collect roster information (in this specific case, 2022). While we know we only want the Steelers’ roster, it is not suggested to use <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> to gather any specific team at this point. Case in point: doing so with this example will result in the <code>gsis_id</code> <em>00-0036326</em> having an “NA” value for a name, despite having over 380 snaps in the 1 RB, 1TE, 3 WR offensive formation. The player associated with that <code>gsis_id</code> is Chase Claypool, who the Steelers traded to the Bears on November 1 of 2022. Because of this, no player name will be associated with that specific <code>gsis_id</code> on the Steelers’ roster (with the end result being a missing value).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You may notice that the resulting data frame, titled <code>pit_roster</code>, has 80 players on the roster despite NFL teams only being permitted to have 53 active players at a time.</p>
<p>This is because the information collected with <code>load_rosters()</code> includes not only active players, but those listed on the practice squad and injured reserve. Additionally, you may notice players listed as <code>R/Retired</code> (such as Stephon Tuitt in our data frame, who retired at the end of the 2022 season). In these situations, this <code>status</code> indicates that the player is listed as ‘reserved-retired’ and that the team continues to hold the player’s rights until the official expiration of their contract. In this case, Tuitt could not come out of retirement prior to his contract ending and play with another team unless first released or traded by Pittsburgh.</p>
</div>
</div>
<p>Despite the wealth of information in the roster information, only the <code>gsis_id</code> and the <code>full_name</code> is required to complete our <code>participation_split</code> data frame. Rather than bringing unnecessary information over during the merge, we can select just the two columns we need and then use <code>left_join()</code> to merge each player’s name on the matching ID in the <code>offense_players</code> column and <code>gsis_id</code> from the roster information.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/merging-rosters-participation_3f56822a3d3400e43e2686277f3e6216">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rosters</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_rosters.html">load_rosters</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rosters</span> <span class="op">&lt;-</span> <span class="va">rosters</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gsis_id</span>, <span class="va">full_name</span><span class="op">)</span></span>
<span></span>
<span><span class="va">participation_split</span> <span class="op">&lt;-</span> <span class="va">participation_split</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">rosters</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"offense_players"</span> <span class="op">=</span> <span class="st">"gsis_id"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">participation_split</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 157 x 4
   offense_personnel offense_players total full_name        
   &lt;chr&gt;             &lt;chr&gt;           &lt;int&gt; &lt;chr&gt;            
 1 1 RB, 1 TE, 3 WR  00-0032897          3 Derek Watt       
 2 1 RB, 1 TE, 3 WR  00-0033869        262 Mitchell Trubisky
 3 1 RB, 1 TE, 3 WR  00-0034142         37 J.C. Hassenauer  
 4 1 RB, 1 TE, 3 WR  00-0034347        781 James Daniels    
 5 1 RB, 1 TE, 3 WR  00-0034768        781 Chukwuma Okorafor
 6 1 RB, 1 TE, 3 WR  00-0034785        744 Mason Cole       
 7 1 RB, 1 TE, 3 WR  00-0034928        235 Steven Sims      
 8 1 RB, 1 TE, 3 WR  00-0035216        745 Diontae Johnson  
 9 1 RB, 1 TE, 3 WR  00-0035217         25 Benny Snell      
10 1 RB, 1 TE, 3 WR  00-0035222        258 Zach Gentry      
# i 147 more rows</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>load_rosters()</code> data is capable of providing data for multiple seasons at once. Through each season, a player’s <code>gsis_id</code> will remain static. Despite this, when merging multiple years of participation data with multiple years of roster information, the data must be matched on the <code>season</code> variable was well. This process involves including <code>season</code> in both the participation data <code>group_by()</code> and the roster information, as seen below.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/roster-multi-year-merge_deed9104f039cc1a185e5e0a4189d623">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">participation_multi_years</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">load_participation</span><span class="op">(</span>season <span class="op">=</span> <span class="fl">2018</span><span class="op">:</span><span class="fl">2022</span>, include_pbp <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">participation_2018_2022</span> <span class="op">&lt;-</span> <span class="va">participation_multi_years</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">offense_formation</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">==</span> <span class="st">"PIT"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_rows.html">separate_rows</a></span><span class="op">(</span><span class="va">offense_players</span>, sep <span class="op">=</span> <span class="st">";"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">season</span>, <span class="va">offense_personnel</span>, <span class="va">offense_players</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>total <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rosters_2018_2022</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_rosters.html">load_rosters</a></span><span class="op">(</span><span class="fl">2018</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">season</span>, <span class="va">gsis_id</span>, <span class="va">full_name</span><span class="op">)</span></span>
<span></span>
<span><span class="va">participation_2018_2022</span> <span class="op">&lt;-</span> <span class="va">participation_2018_2022</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">rosters_2018_2022</span>,</span>
<span>            by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"season"</span>, <span class="st">"offense_players"</span> <span class="op">=</span> <span class="st">"gsis_id"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>If your analysis requires providing great granularity, the <code>load_rosters_weekly()</code> function provides the same information as <code>load_rosters()</code> but structures it in weekly format by season (or over multiple seasons, if needed).</p>
</section><section id="the-load_teams-function" class="level3" data-number="3.5.3"><h3 data-number="3.5.3" class="anchored" data-anchor-id="the-load_teams-function">
<span class="header-section-number">3.5.3</span> The <code>load_teams()</code> Function</h3>
<p>A tool heavily used in the data visualization process, the <code>load_teams()</code> function provides information pertaining to each NFL team’s colors and logos, as well as providing a way to merge data frames that have differing values for teams.</p>
<p>More often than not, we will be using <code>left_join</code> to bring in team information (colors, logos, etc.) into a another data frame. We will utilize this function heavily in the example below.</p>
<p>However, it is important to note the one argument that <code>load_teams()</code> accepts: <code>current</code>. Depending on the time span of your data, it is possible that you have teams included prior to relation (like the St.&nbsp;Louis Rams). If you are sure that you do not have such a scenario, you can use <code>load_teams(current = TRUE)</code> which will bring in just the current 32 NFL teams.</p>
<p>However, if you need to include teams before expansion, you can use <code>load_teams(current = FALSE)</code> which will result in a data frame with 36 NFL teams.</p>
</section><section id="the-load_officials-function" class="level3" data-number="3.5.4"><h3 data-number="3.5.4" class="anchored" data-anchor-id="the-load_officials-function">
<span class="header-section-number">3.5.4</span> The <code>load_officials()</code> Function</h3>
<p>The <code>load_officials()</code> data will return data, from 2015 to present, outlining which officials were assigned to which game. The data also includes information regarding each referee’s position, jersey number, and their official NFL ID number. Importantly, the data is structured to also include both a <code>game_id</code> and <code>game_key</code> that are sorted by <code>season</code> and <code>week</code>, allowing you to merge the information other data frames.</p>
<p>With the data, we can - for example - examine which NFL officiating crews called the most penalties during the 2022 NFL season. Doing so requires a bit of work in order to assign a unique <code>crew_id</code> to each stable of officials “working” under a lead referee.</p>
<p>As an example, we can create data frame called <code>nfl_officials</code> that contains the official and referee information for each game during the 2022 season. After, in order to get the referee for each crew, use <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> to select those crew members with the “Referee” position and then create a new column titled <code>crew_id</code> that takes the numeric official ID for each distinct Referee.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/officials-starting-data_88591df4bf44aaf784ddf1f01eaf669c">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nfl_officials</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_officials.html">load_officials</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span></span>
<span></span>
<span><span class="va">referees</span> <span class="op">&lt;-</span> <span class="va">nfl_officials</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">position</span> <span class="op">==</span> <span class="st">"Referee"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>crew_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">official_id</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">official_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With a unique <code>crew_id</code> associated with each Referee, we can now use <code>left_join()</code> to bring that information back into our <code>nfl_officials</code> data by merging the <code>game_id</code> and <code>crew_id</code> to the corresponding <code>game_id</code>.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/merging-crew-id-to-data_f24059a639881bfd8df5af1e4e944a2e">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nfl_officials</span> <span class="op">&lt;-</span> <span class="va">nfl_officials</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">referees</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">game_id</span>, <span class="va">crew_id</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"game_id"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting <code>nfl_officials</code> data frame now includes all the original information and now a consistent <code>crew_id</code> for each team that the referee works with.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/showcasing-data_bff0ea11162eba71fc7bed1c98e55284">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nfl_officials</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,065 x 10
   game_id   game_key official_name position jersey_number official_id
   &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;         &lt;chr&gt;            &lt;int&gt; &lt;chr&gt;      
 1 20220908~ 58838    Nathan Jones  Field J~            42 174        
 2 20220908~ 58838    Matt Edwards  Back Ju~            96 178        
 3 20220908~ 58838    Mike Carr     Down Ju~            63 168        
 4 20220908~ 58838    Eugene Hall   Side Ju~           103 108        
 5 20220908~ 58838    Jeff Seeman   Line Ju~            45 23         
 6 20220908~ 58838    Carl Cheffers Referee             51 3          
 7 20220908~ 58838    Brandon Cruse Umpire               0 201        
 8 20220911~ 58839    Mike Morton   Umpire               0 206        
 9 20220911~ 58839    John Jenkins  Field J~           117 86         
10 20220911~ 58839    Danny Short   Down Ju~           113 172        
# i 2,055 more rows
# i 4 more variables: season &lt;int&gt;, season_type &lt;chr&gt;, ...</code></pre>
</div>
</div>
<p>To calculate the total number of penalties flagged by each crew, we must first bring in the play-by-play from the 2022 season. After, we will use <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> to gather only those plays where a flag was thrown, and then <code>select()</code> the relevant columns, and finally <code>summarize()</code> by the <code>old_game_id</code> to get the total penalties called and the total penalty yards as a result of those penalties.</p>
<p>After, we conduct another <code>left_join()</code> to bring in the specific penalty information into our <code>nfl_officials</code> data frame.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/penalties-from-pbp_6c0e4f60007192157915d40eb9ec4731">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">penalty_pbp</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pbp.html">load_pbp</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span></span>
<span></span>
<span><span class="va">penalties</span> <span class="op">&lt;-</span> <span class="va">penalty_pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">penalty</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">game_id</span>, <span class="va">old_game_id</span>, <span class="va">season</span>, <span class="va">play_id</span>,</span>
<span>         <span class="va">desc</span>, <span class="va">home_team</span>, <span class="va">away_team</span>,</span>
<span>         <span class="va">posteam</span>, <span class="va">defteam</span>, <span class="va">week</span>, <span class="va">penalty_team</span>,</span>
<span>         <span class="va">penalty_type</span>, <span class="va">penalty</span>, <span class="va">penalty_player_id</span>,</span>
<span>         <span class="va">penalty_player_name</span>, <span class="va">penalty_yards</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">old_game_id</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>total_called <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">penalty</span> <span class="op">==</span> <span class="fl">1</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            total_yards <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">penalty_yards</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nfl_officials</span> <span class="op">&lt;-</span> <span class="va">nfl_officials</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">penalties</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"game_id"</span> <span class="op">=</span> <span class="st">"old_game_id"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">game_id</span>, <span class="va">official_name</span>, <span class="va">position</span>,</span>
<span>         <span class="va">crew_id</span>, <span class="va">total_called</span>, <span class="va">total_yards</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With the data now combined, we can <code>group_by()</code> each game’s unique <code>game_id</code> and then use <code>summarize()</code> to sum the penalties called and the penalty yardage. After arranging the results in descending order by the total number of penalties, we can see that Referee Carl Cheffers, and his crew, called the most penalties during the 2022 NFL season with 223 and, unsurprisingly, also had the highest amount of penalty yards with 1,916.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/summarizing-referee-information_5e1679a3d0619a8290c4c5c24844a955">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nfl_officials</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">game_id</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">position</span> <span class="op">==</span> <span class="st">"Referee"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">crew_id</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>referee <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">official_name</span><span class="op">)</span>,</span>
<span>            all_pen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">total_called</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            all_yards <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">total_yards</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">all_pen</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 x 4
   crew_id referee        all_pen all_yards
     &lt;int&gt; &lt;chr&gt;            &lt;int&gt;     &lt;dbl&gt;
 1       1 Carl Cheffers      223      1916
 2      11 Scott Novak        204      1584
 3       6 Brad Allen         203      1511
 4      16 Clete Blakeman     203      1562
 5       5 Shawn Hochuli      199      1780
 6       4 Clay Martin        198      1684
 7      17 Adrian Hill        193      1564
 8       2 Alex Kemp          192      1602
 9      10 Tra Blake          189      1545
10      15 Ronald Torbert     185      1549</code></pre>
</div>
</div>
</section><section id="the-load_trades-function" class="level3" data-number="3.5.5"><h3 data-number="3.5.5" class="anchored" data-anchor-id="the-load_trades-function">
<span class="header-section-number">3.5.5</span> The <code>load_trades()</code> Function</h3>
<p>The <code>load_trades()</code> function returns a data frames that includes all trades in the NFL on a season-by-season basis with information pertaining to: <code>trade_id</code>, <code>season</code>, <code>trade_date</code>, <code>gave</code>, <code>received</code>, <code>pick_season</code>, <code>pick_round</code>, <code>pick_number</code>, <code>conditional</code>, <code>pfr_id</code>, <code>pfr_name</code>.</p>
<p>For example, we can gather every trade involving the New England Patriots with the following code:</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/collecting-ne-trade_d602339bca4341f659e31233fd06873a">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ne_trades</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_trades.html">load_trades</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">gave</span> <span class="op">==</span> <span class="st">"NE"</span> <span class="op">|</span> <span class="va">received</span> <span class="op">==</span> <span class="st">"NE"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ne_trades</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 506 x 11
   trade_id season trade_date gave  received pick_season pick_round
      &lt;dbl&gt;  &lt;dbl&gt; &lt;date&gt;     &lt;chr&gt; &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;
 1      704   2002 2002-03-11 GB    NE              2002          4
 2      704   2002 2002-03-11 NE    GB                NA         NA
 3      716   2002 2002-04-20 NE    WAS             2002          1
 4      716   2002 2002-04-20 NE    WAS             2002          3
 5      716   2002 2002-04-20 NE    WAS             2002          7
 6      716   2002 2002-04-20 WAS   NE              2002          1
 7      725   2002 2002-04-21 DEN   NE              2002          4
 8      725   2002 2002-04-21 NE    DEN             2002          4
 9      725   2002 2002-04-21 NE    DEN             2002          5
10      727   2002 2002-04-21 DAL   NE              2002          7
# i 496 more rows
# i 4 more variables: pick_number &lt;dbl&gt;, conditional &lt;dbl&gt;, ...</code></pre>
</div>
</div>
<p>If you want to view a trade that involves a specific player, you can do the same as above but <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> for a specific player. As an example, we do search for the trade that resulted in the New England Patriots sending Drew Bledsoe to the Buffalo Bills.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/bledsoe-to-bills_7ace40c2a1c6dfc6f9a83b4109f404bd">
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bledsoe_trade</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_trades.html">load_trades</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">trade_id</span> <span class="op">==</span> <span class="va">trade_id</span><span class="op">[</span><span class="va">pfr_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Drew Bledsoe"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bledsoe_trade</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 x 11
  trade_id season trade_date gave  received pick_season pick_round
     &lt;dbl&gt;  &lt;dbl&gt; &lt;date&gt;     &lt;chr&gt; &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;
1      728   2002 2002-04-22 BUF   NE              2003          1
2      728   2002 2002-04-22 NE    BUF               NA         NA
# i 4 more variables: pick_number &lt;dbl&gt;, conditional &lt;dbl&gt;,
#   pfr_id &lt;chr&gt;, pfr_name &lt;chr&gt;</code></pre>
</div>
</div>
<p>Since the <code>load_trades()</code> function also includes NFL Draft round and pick numbers (if included in a trade), we can also - for example - determine all trades that involved a top ten pick switching hands.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/top-ten-picks-trades_e8a6b0359bc18930b09d8efc5e98d2ec">
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">top_ten_picks</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_trades.html">load_trades</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">pick_round</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">pick_number</span> <span class="op">&lt;=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">top_ten_picks</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 57 x 11
   trade_id season trade_date gave  received pick_season pick_round
      &lt;dbl&gt;  &lt;dbl&gt; &lt;date&gt;     &lt;chr&gt; &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;
 1      711   2002 2002-04-20 DAL   KC              2002          1
 2      711   2002 2002-04-20 KC    DAL             2002          1
 3      661   2003 2003-04-26 CHI   NYJ             2003          1
 4      662   2003 2003-04-26 ARI   NO              2003          1
 5       16   2004 2004-04-24 CLE   DET             2004          1
 6       16   2004 2004-04-24 DET   CLE             2004          1
 7       64   2005 2005-03-03 OAK   MIN             2005          1
 8      189   2007 2007-03-22 ATL   HOU             2007          1
 9      189   2007 2007-03-22 HOU   ATL             2007          1
10      197   2007 2007-04-28 SF    NE              2008          1
# i 47 more rows
# i 4 more variables: pick_number &lt;dbl&gt;, conditional &lt;dbl&gt;, ...</code></pre>
</div>
</div>
</section><section id="the-load_draft_picks-function" class="level3" data-number="3.5.6"><h3 data-number="3.5.6" class="anchored" data-anchor-id="the-load_draft_picks-function">
<span class="header-section-number">3.5.6</span> The <code>load_draft_picks()</code> Function</h3>
<p>The <code>load_draft_picks()</code> function will load information pertaining to every draft pick dating back to 1980. Aside from the information you would expect (the player’s name, the team that draft, round, pick number, position, etc.), the <code>load_draft_picks()</code> function also includes data regarding how many seasons the player played, the amount of times they were named to Pro Bowls, and top-level statistics regarding rushing, passing, receiving, and defensive metrics.</p>
<p>The <code>load_draft_picks()</code> function can be used to explore multiple different facets of the NFL Draft. For example, there is a belief in the analytics community to never draft a running back in the first round. Without getting into the reasoning behind that belief, we can quickly create a visualization of career rushing yards per running back compared to their draft position.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/running-back-draft-position_5bb55724b2dc45220b7e56373620dba5">
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">draft_picks</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_draft_picks.html">load_draft_picks</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">teams</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_teams.html">load_teams</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rb_picks</span> <span class="op">&lt;-</span> <span class="va">draft_picks</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">position</span> <span class="op">==</span> <span class="st">"RB"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">pick</span>, <span class="va">team</span>, <span class="va">rush_atts</span>, <span class="va">rush_yards</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">pick</span> <span class="op">&lt;=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rb_picks</span> <span class="op">&lt;-</span> <span class="va">rb_picks</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">teams</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"team"</span> <span class="op">=</span> <span class="st">"team_abbr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/running-back-plot_39b454e2e022a841e90696fe75b3dfbc">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">rb_picks</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">rush_yards</span>, y <span class="op">=</span> <span class="va">pick</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>color <span class="op">=</span> <span class="va">rb_picks</span><span class="op">$</span><span class="va">team_color</span>, size <span class="op">=</span> <span class="va">rb_picks</span><span class="op">$</span><span class="va">rush_atts</span> <span class="op">/</span> <span class="fl">500</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Career Rushing Yards"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Pick Number"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**Career Rushing Yards vs. Pick Number**"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"1980 to 2022"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*An Introduction to NFL Analytics with R*&lt;br&gt;</span></span>
<span><span class="st">       **Brad J. Congelio**"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="03-nfl-analytics-functions_files/figure-html/running-back-plot-1.png" style="width:95.0%;height:95.0%" class="figure-img"></p>
<figcaption class="figure-caption">Career Rushing Yards vs.&nbsp;Draft Pick</figcaption></figure>
</div>
</div>
</div>
<p>According to the plot, there has been a limited number of running backs draft in the top 20 to go over 10,000 career yards. However, there are more running backs - some still active - drafted in the mid-range of the draft that are approaching, or have eclipsed, the 10,000 yard mark.</p>
</section><section id="the-load_combine-function" class="level3" data-number="3.5.7"><h3 data-number="3.5.7" class="anchored" data-anchor-id="the-load_combine-function">
<span class="header-section-number">3.5.7</span> The <code>load_combine()</code> Function</h3>
<p>The <code>load_combine()</code> function provides NFL Combine data dating back to 2000. Aside from biographical information for each player (including eventual draft position), the data include the player’s scores in the 40-yard dash, the bench press, the vertical, the broad jump, the cone drill, and the shuttle drill.</p>
<p>We can join information from <code>load_combine()</code> with outside information to determine if there is any correlation between a running back’s 40-yard dash time in the combine and the total number of rushing yard accumulated during his career.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/40-dash-yards-correlation_b8a64bc00f42cd8b8de7faf0c3d798a7">
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">combine_data</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_combine.html">load_combine</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">pfr_id</span>, <span class="va">forty</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">pfr_id</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">forty</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rosters</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_rosters.html">load_rosters</a></span><span class="op">(</span><span class="fl">2000</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gsis_id</span>, <span class="va">pfr_id</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="va">gsis_id</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">player_stats</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                            stat_type <span class="op">=</span> <span class="st">"offense"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">position</span> <span class="op">==</span> <span class="st">"RB"</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">player_name</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>           <span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">player_name</span>, <span class="va">player_id</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>total_yards <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">rushing_yards</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            team <span class="op">=</span> <span class="fu">last</span><span class="op">(</span><span class="va">recent_team</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">player_stats</span> <span class="op">&lt;-</span> <span class="va">player_stats</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">rosters</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"player_id"</span> <span class="op">=</span> <span class="st">"gsis_id"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">player_stats</span> <span class="op">&lt;-</span> <span class="va">player_stats</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">pfr_id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">player_stats</span> <span class="op">&lt;-</span> <span class="va">player_stats</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">combine_data</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pfr_id"</span> <span class="op">=</span> <span class="st">"pfr_id"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">forty</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">player_stats</span> <span class="op">&lt;-</span> <span class="va">player_stats</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">teams</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"team"</span> <span class="op">=</span> <span class="st">"team_abbr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/rb-40-plot_446c841d7d2133539a57eb6de1780d95">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">player_stats</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">forty</span>, y <span class="op">=</span> <span class="va">total_yards</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>color <span class="op">=</span> <span class="va">player_stats</span><span class="op">$</span><span class="va">team_color</span>, size <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="va">lm</span>, se <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>              color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>              linetype <span class="op">=</span> <span class="st">"dashed"</span>,</span>
<span>              size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Forty-Yard Dash Time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Career Rushing Yards"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**Forty-Yard Dash Time vs. Career Rushing Yards**"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"2000 to 2022"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*An Introduction to NFL Analytics with R*&lt;br&gt;</span></span>
<span><span class="st">       **Brad J. Congelio**"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="03-nfl-analytics-functions_files/figure-html/rb-40-plot-1.png" style="width:95.0%;height:95.0%" class="figure-img"></p>
<figcaption class="figure-caption">Comparing RBs Forty-Yard Dash Time vs.&nbsp;Career Total Yards</figcaption></figure>
</div>
</div>
</div>
<p>The visualization indicates that there is little, if any, direct correlation between a running back’s 40-yard dash time and his career total rushing yards. There are likely other factors that contribute to total rushing yards, such as a running back’s agility and vision and - perhaps most important - the quality of the offensive line over the duration of the running back’s career.</p>
</section><section id="the-load_nextgen_stats-function" class="level3" data-number="3.5.8"><h3 data-number="3.5.8" class="anchored" data-anchor-id="the-load_nextgen_stats-function">
<span class="header-section-number">3.5.8</span> The <code>load_nextgen_stats()</code> Function</h3>
<p>The <code>load_nextgen_stats()</code> function retrieves player-level weekly statistics as provided by NFL Next Gen Stats dating back to the 2016 season. While three different stat types are provided (passing, receiving, and rushing), it is important to note that the data will only contain those players above a minimum number of attempts as determined by the NFL Next Gen Stats team.</p>
<p>To illustrate what can be done with the <code>load_nextgen_stats()</code> function, we will gather information to create two different plots. First, we can plot each quarterback’s average time to throw against their average completed air yards. Second, we will construct a graph to highlight which running backs had more actual rushing yards than the NGS “expected rushing yards” model.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/ngs-passing-data_dc739f9de80587b18af84960c6e032ea">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ngs_data_passing</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_nextgen_stats.html">load_nextgen_stats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2022</span>,</span>
<span>                                                 stat_type <span class="op">=</span> <span class="st">"passing"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">week</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">player_display_name</span>, <span class="va">team_abbr</span>,</span>
<span>         <span class="va">avg_time_to_throw</span>, <span class="va">avg_completed_air_yards</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ngs_data_passing</span> <span class="op">&lt;-</span> <span class="va">ngs_data_passing</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">teams</span>, b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"team_abbr"</span> <span class="op">=</span> <span class="st">"team_abbr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/ngs-passing-plot_f841a3fe4c6eba6b320ed9adb22c40ae">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">ngs_data_passing</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">avg_time_to_throw</span>,</span>
<span>                                    y <span class="op">=</span> <span class="va">avg_completed_air_yards</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ngs_data_passing</span><span class="op">$</span><span class="va">avg_completed_air_yards</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">0.8</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ngs_data_passing</span><span class="op">$</span><span class="va">avg_time_to_throw</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">0.8</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3.5</span>, color <span class="op">=</span> <span class="va">ngs_data_passing</span><span class="op">$</span><span class="va">team_color</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text_repel</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">player_display_name</span><span class="op">)</span>,</span>
<span>                  family <span class="op">=</span> <span class="st">"Roboto"</span>, fontface <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Average Time to Throw"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Average Completed Air Yards"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**Avgerage Time to Throw vs. Average Air Yards**"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"2022 Regular Season"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*An Introduction to NFL Analytics with R*&lt;br&gt;</span></span>
<span><span class="st">       **Brad J. Congelio**"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="03-nfl-analytics-functions_files/figure-html/ngs-passing-plot-1.png" style="width:95.0%;height:95.0%" class="figure-img"></p>
<figcaption class="figure-caption">Comparing a QB’s average time to throw to their average completed air yards</figcaption></figure>
</div>
</div>
</div>
<p>The resulting plot shows that Dak Prescott, Jalen Hurts, and Ryan Tannehill had an average completed air yard above the NFL average despite getting rid of the ball quicker than most other quarterbacks in the league. Conversely, Patrick Mahomes, Daniel Jones, and Justin Herbert has under average completed air yards despite holding on to the ball longer than the rest of the league (on average).</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/nga-rushing-data_749f7f286400d19fa12ee77779f5f423">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ngs_data_rushing</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_nextgen_stats.html">load_nextgen_stats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2022</span>,</span>
<span>                                                 stat_type <span class="op">=</span> <span class="st">"rushing"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">week</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">player_display_name</span>, <span class="va">team_abbr</span>, <span class="va">expected_rush_yards</span>,</span>
<span>         <span class="va">rush_yards_over_expected</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>actual_rush_yards <span class="op">=</span> <span class="va">expected_rush_yards</span> <span class="op">+</span> <span class="va">rush_yards_over_expected</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ngs_data_rushing</span> <span class="op">&lt;-</span> <span class="va">ngs_data_rushing</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">teams</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"team_abbr"</span> <span class="op">=</span> <span class="st">"team_abbr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/ngs-rushing-plot_8c270bafbb6d2c5ac03c0bf09b64c289">
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">ngs_data_rushing</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">expected_rush_yards</span>,</span>
<span>                                    y <span class="op">=</span> <span class="va">actual_rush_yards</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="va">lm</span>, se <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>              color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>              size <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>              linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3.5</span>, color <span class="op">=</span> <span class="va">ngs_data_rushing</span><span class="op">$</span><span class="va">team_color</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text_repel</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">player_display_name</span><span class="op">)</span>,</span>
<span>                  family <span class="op">=</span> <span class="st">"Roboto"</span>,</span>
<span>                  fontface <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Expected Rush Yards"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Actual Rush Yards"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Expected Rush Yards vs. Actual Rush Yards"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"2022 Regular Season"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*An Introduction to NFL Analytics with R*&lt;br&gt;</span></span>
<span><span class="st">       **Brad J. Congelio**"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="03-nfl-analytics-functions_files/figure-html/ngs-rushing-plot-1.png" style="width:95.0%;height:95.0%" class="figure-img"></p>
<figcaption class="figure-caption">Expected Rushing Yards vs.&nbsp;Actual Rushing Yards using Next Gen Stats</figcaption></figure>
</div>
</div>
</div>
<p>After plotting the rushing data from Next Gen Stats, we can see that Nick Chubb was well above the expected yardage metric while Ezekiel Elliott, Alvin Kamara, Najee Harris, and Dalvin Cook all had actual rushing yards that fell below what was expected by the model.</p>
</section><section id="the-load_espn_qbr-function" class="level3" data-number="3.5.9"><h3 data-number="3.5.9" class="anchored" data-anchor-id="the-load_espn_qbr-function">
<span class="header-section-number">3.5.9</span> The <code>load_espn_qbr()</code> Function</h3>
<p>With information dating back to the 2006 season, the <code>load_espn_qbr()</code> function provides a multitude of data points, including:</p>
<ol type="1">
<li>
<code>qbr_total</code> - the adjusted total QBR which is calculated on a scale of 0-100 based on the strength of the defenses played.</li>
<li>
<code>pts_added</code> - the number of total points added by a quarterback adjusted above the average level of all other QBs.</li>
<li>
<code>epa_total</code> - the total number of expected points added for each quarterback as calculated by ESPN’s win probability model.</li>
<li>
<code>pass</code> - the total of expected points added for just pass plays.</li>
<li>
<code>run</code> - the total of expected points added for just run plays.</li>
<li>
<code>qbr_raw</code> - the QBR without adjustment for strength of defense.</li>
<li>
<code>sack</code> - the adjustment for expected points added for sacks.</li>
</ol>
<p>While the QBR metric has fallen out of grace among the analytics community in recent years, we can still compare the difference between the adjusted and unadjusted QBR scores to visualize the impact of defensive strength on the total.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/qbr-adjusted-unadjusted_ec18a2d45b16e8cb518ec4eba7070b77">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">espn_qbr</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_espn_qbr.html">load_espn_qbr</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">name_short</span>, <span class="va">team_abb</span>, <span class="va">qbr_total</span>, <span class="va">qbr_raw</span><span class="op">)</span></span>
<span></span>
<span><span class="va">espn_qbr</span> <span class="op">&lt;-</span> <span class="va">espn_qbr</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">teams</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"team_abb"</span> <span class="op">=</span> <span class="st">"team_abbr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/qbr-adjusted-plot_c6cdf85b6f5099282abfc7b5deb666fe">
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">espn_qbr</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">qbr_total</span>, y <span class="op">=</span> <span class="va">qbr_raw</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="va">lm</span>, se <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>              color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>              linetype <span class="op">=</span> <span class="st">"dashed"</span>,</span>
<span>              size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>color <span class="op">=</span> <span class="va">espn_qbr</span><span class="op">$</span><span class="va">team_color</span>, size <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"QBR - Adjusted"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"QBR - Unadjusted"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"QBR: Adjusted vs. Adjusted Scores"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Based on ESPN's Model: 2022 Regular Season"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*An Introduction to NFL Analytics with R*&lt;br&gt;</span></span>
<span><span class="st">       **Brad J. Congelio**"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="03-nfl-analytics-functions_files/figure-html/qbr-adjusted-plot-1.png" style="width:95.0%;height:95.0%" class="figure-img"></p>
<figcaption class="figure-caption">Comparing Adjusted and Adjusted Quarterback Ratings</figcaption></figure>
</div>
</div>
</div>
</section><section id="the-load_pfr_advstats-function" class="level3" data-number="3.5.10"><h3 data-number="3.5.10" class="anchored" data-anchor-id="the-load_pfr_advstats-function">
<span class="header-section-number">3.5.10</span> The <code>load_pfr_advstats()</code> Function</h3>
<p>The <code>load_pfr_advstats()</code> function provides statistics from Pro Football Reference starting with the 2018 season for passing, rushing, receiving, and defense. The function allows for collecting the data at either the weekly or season level with the <code>summary_level</code> argument.</p>
<p>To begin exploring the data, let’s examine the relationship between the number of dropped passes each quarterback endured during the 2022 regular season compared to the total number of <code>bad_throws</code> charted by Pro Football Reference. An argument can be made that a dropped pass without the pass being considered “bad” is the fault of the wide receiver, while a dropped pass that <em>is</em> charted as “bad” falls on the quarterback.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>When working with data from <code>load_pfr_advstats()</code>, it is important to remember that you must use the <code>clean_team_abbrs()</code> function from <code>nflreadr</code> as there is a difference between the abbreviations used by PFR and the abbreviations used within the <code>nflverse</code>.</p>
</div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/pfr-stats-qb_83e595a9a16531637795ee412bbd9e27">
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pfr_stats_pass</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pfr_advstats.html">load_pfr_advstats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2022</span>,</span>
<span>                                              stat_type <span class="op">=</span> <span class="st">"pass"</span>,</span>
<span>                                              summary_level <span class="op">=</span> <span class="st">"season"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">player</span>, <span class="va">pass_attempts</span>, <span class="va">team</span>, <span class="va">drops</span>, <span class="va">bad_throws</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">pass_attempts</span> <span class="op">&gt;=</span> <span class="fl">400</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pfr_stats_pass</span><span class="op">$</span><span class="va">team</span> <span class="op">&lt;-</span> <span class="fu">clean_team_abbrs</span><span class="op">(</span><span class="va">pfr_stats_pass</span><span class="op">$</span><span class="va">team</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pfr_stats_pass</span> <span class="op">&lt;-</span> <span class="va">pfr_stats_pass</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">teams</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"team"</span> <span class="op">=</span> <span class="st">"team_abbr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/qb-pfr-stats-plot_6be320e6ef2ace89c3cb4e8adc95750d">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">pfr_stats_pass</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">bad_throws</span>, y <span class="op">=</span> <span class="va">drops</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pfr_stats_pass</span><span class="op">$</span><span class="va">drops</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pfr_stats_pass</span><span class="op">$</span><span class="va">bad_throws</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>color <span class="op">=</span> <span class="va">pfr_stats_pass</span><span class="op">$</span><span class="va">team_color</span>, size <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text_repel</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">player</span><span class="op">)</span>,</span>
<span>                  family <span class="op">=</span> <span class="st">"Roboto"</span>, fontface <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Bad Throws"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Drops"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**QB Bad Throws vs. WR Drops**"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"2022 Regular Season"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*An Introduction to NFL Analytics with R*&lt;br&gt;</span></span>
<span><span class="st">       **Brad J. Congelio**"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="03-nfl-analytics-functions_files/figure-html/qb-pfr-stats-plot-1.png" style="width:95.0%;height:95.0%" class="figure-img"></p>
<figcaption class="figure-caption">Example RStudio Console Output</figcaption></figure>
</div>
</div>
</div>
<p>Quarterbacks such as Patrick Mahomes, Josh Allen, and Tom Brady had some of the highest drop numbers in the league but were also charted as having the highest number of bad throws, as well. This indicates that - without additional context - the wide receivers may not be as much at fault for the drops compared to the wide receivers that dropped passes from Daniel Jones and Russell Wilson, both of whom had a lower number of bad throws.</p>
<p>By using the rushing data provided by <code>load_pfr_advstats()</code>, we can examine how “hard” it is to tackle a running back by examining the relationship between their yards before contact and yards after contact.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Because the list of running backs with more than 200 attempts includes Christian McCaffrey, it is necessary to use the <code>case_when()</code> function to switch his <code>tm</code> from <code>2TMS</code> to the team that he finished the season with (<code>SF</code>). Otherwise, using <code>left_join()</code> for team colors would not work for McCafffrey since <code>2TMS</code> is not a recognized team abbreviation.</p>
</div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/pfr-rush-stats_aa66a8738e76de854431ddf7e771d936">
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pfr_stats_rush</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pfr_advstats.html">load_pfr_advstats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2022</span>,</span>
<span>                                              stat_type <span class="op">=</span> <span class="st">"rush"</span>,</span>
<span>                                              summary_level <span class="op">=</span> <span class="st">"season"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">player</span>, <span class="va">tm</span>, <span class="va">att</span>, <span class="va">ybc</span>, <span class="va">yac</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">att</span> <span class="op">&gt;=</span> <span class="fl">200</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>tm <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="va">player</span> <span class="op">==</span> <span class="st">"Christian McCaffrey"</span> <span class="op">~</span> <span class="st">"SF"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">tm</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pfr_stats_rush</span><span class="op">$</span><span class="va">tm</span> <span class="op">&lt;-</span> <span class="fu">clean_team_abbrs</span><span class="op">(</span><span class="va">pfr_stats_rush</span><span class="op">$</span><span class="va">tm</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pfr_stats_rush</span> <span class="op">&lt;-</span> <span class="va">pfr_stats_rush</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">teams</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tm"</span> <span class="op">=</span> <span class="st">"team_abbr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/pfr-rush-stats-plot_1b3c4839c4b79f879c5aa178f84ea6d8">
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">pfr_stats_rush</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">ybc</span>, y <span class="op">=</span> <span class="va">yac</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pfr_stats_rush</span><span class="op">$</span><span class="va">yac</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pfr_stats_rush</span><span class="op">$</span><span class="va">ybc</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>color <span class="op">=</span> <span class="va">pfr_stats_rush</span><span class="op">$</span><span class="va">team_color</span>, size <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text_repel</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">player</span><span class="op">)</span>,</span>
<span>                  family <span class="op">=</span> <span class="st">"Roboto"</span>, fontface <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Yards Before Contact"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Yards After Contact"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**Running Backs: Yards Before and After Contact**"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"2022 Regular Season"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*An Introduction to NFL Analytics with R*&lt;br&gt;</span></span>
<span><span class="st">       **Brad J. Congelio**"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="03-nfl-analytics-functions_files/figure-html/pfr-rush-stats-plot-1.png" style="width:95.0%;height:95.0%" class="figure-img"></p>
<figcaption class="figure-caption">Exploring which running backs get more yards before and after contact</figcaption></figure>
</div>
</div>
</div>
<p>In the same vein as the running back statistics, we can use <code>load_pfr_advstats()</code> to explore which wide receivers gained the most yardage after catching the ball.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/pfr-rec-stats_dd97f08d51aba4ffbd0f326cfa842ea6">
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pfr_stats_rec</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pfr_advstats.html">load_pfr_advstats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2022</span>, stat_type <span class="op">=</span> <span class="st">"rec"</span>,</span>
<span>                                             summary_level <span class="op">=</span> <span class="st">"season"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">rec</span> <span class="op">&gt;=</span> <span class="fl">80</span> <span class="op">&amp;</span> <span class="va">pos</span> <span class="op">==</span> <span class="st">"WR"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">player</span>, <span class="va">tm</span>, <span class="va">rec</span>, <span class="va">ybc</span>, <span class="va">yac</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pfr_stats_rec</span> <span class="op">&lt;-</span> <span class="va">pfr_stats_rec</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">teams</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tm"</span> <span class="op">=</span> <span class="st">"team_abbr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/rec-pfr-stats-plot_35c87e6691ad5617d85ed32c684364f5">
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">pfr_stats_rec</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">ybc</span>, y <span class="op">=</span> <span class="va">yac</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pfr_stats_rec</span><span class="op">$</span><span class="va">yac</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pfr_stats_rec</span><span class="op">$</span><span class="va">ybc</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>color <span class="op">=</span> <span class="va">pfr_stats_rec</span><span class="op">$</span><span class="va">team_color</span>, size <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text_repel</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">player</span><span class="op">)</span>,</span>
<span>                  family <span class="op">=</span> <span class="st">"Roboto"</span>, fontface <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Yards At Point of Catch"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Yards After Catch"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**Yards at Point of Catch vs. Yards After Catch**"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"2022 Regular Season"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*An Introduction to NFL Analytics with R*&lt;br&gt;</span></span>
<span><span class="st">       **Brad J. Congelio**"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="03-nfl-analytics-functions_files/figure-html/rec-pfr-stats-plot-1.png" style="width:95.0%;height:95.0%" class="figure-img"></p>
<figcaption class="figure-caption">Which wide receivers gain the most yardage after catching the ball?</figcaption></figure>
</div>
</div>
</div>
<p>Given the outstanding season that Justin Jefferson had in 2022, it is unsurprising to see him in the upper-right quadrant of the plot. Of his 1,809 receiving yards in the season, just under 1,200 of them came through air yards while he gained just over an additional 600 yards on the ground after the catch. On the other hand, D.K. Metcalf and Diontae Johnson were more often than not tackled almost immediately after catching the football.</p>
<p>Given the structure of the data collected from <code>load_pfr_advstats()</code>, the information can also be aggregated to define team total. For example, we can use the defensive statistics for blitzes and sacks from individual players to calculate the relationship between a team’s total number of blitzes against the number of sacks those blitzes produce.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/blitze-sacks-code_4aeb1d04747a0f643c7e08d823791d11">
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pfr_stats_def</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pfr_advstats.html">load_pfr_advstats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2022</span>,</span>
<span>                                             stat_type <span class="op">=</span> <span class="st">"def"</span>,</span>
<span>                                             summary_level <span class="op">=</span> <span class="st">"season"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">tm</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2TM"</span>, <span class="st">"3TM"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">tm</span>, <span class="va">bltz</span>, <span class="va">sk</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">tm</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>total_blitz <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">bltz</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            total_sack <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">sk</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pfr_stats_def</span> <span class="op">&lt;-</span> <span class="va">pfr_stats_def</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">teams</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tm"</span> <span class="op">=</span> <span class="st">"team_abbr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/blitz-sacks-plot_f6984cea6899c40d14048179b33ab1c0">
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">pfr_stats_def</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">total_blitz</span>, y <span class="op">=</span> <span class="va">total_sack</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pfr_stats_def</span><span class="op">$</span><span class="va">total_sack</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pfr_stats_def</span><span class="op">$</span><span class="va">total_blitz</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_image</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>image <span class="op">=</span> <span class="va">team_logo_wikipedia</span><span class="op">)</span>, asp <span class="op">=</span> <span class="fl">16</span><span class="op">/</span><span class="fl">9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Total Blitzes"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Total Sacks"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**Total Blitzes vs. Total Sacks**"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"2022 Regular Season"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*An Introduction to NFL Analytics with R*&lt;br&gt;</span></span>
<span><span class="st">       **Brad J. Congelio**"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="03-nfl-analytics-functions_files/figure-html/blitz-sacks-plot-1.png" style="width:95.0%;height:95.0%" class="figure-img"></p>
<figcaption class="figure-caption">Which defensive units are most efficient at creating sacks from blitzes?</figcaption></figure>
</div>
</div>
</div>
<p>The Philadelphia Eagles were absolutely dominate during the 2022 regular season when it came to turning blitzes into sacks. On the other hand, the Arizona Cardinals, New York Giants, and Pittsburgh Steelers produced high amounts of pressure with blitzes but were not able to convert them into sacks as a consistent basis.</p>
</section><section id="the-load_snap_counts-function" class="level3" data-number="3.5.11"><h3 data-number="3.5.11" class="anchored" data-anchor-id="the-load_snap_counts-function">
<span class="header-section-number">3.5.11</span> The <code>load_snap_counts()</code> Function</h3>
<p>The <code>load_snap_counts()</code> function returns week-level snap counts for all players from Pro Football Reference dating back to the 2012 season.</p>
</section><section id="the-load_contracts-function" class="level3" data-number="3.5.12"><h3 data-number="3.5.12" class="anchored" data-anchor-id="the-load_contracts-function">
<span class="header-section-number">3.5.12</span> The <code>load_contracts()</code> Function</h3>
<p>The <code>load_contracts()</code> function brings in data from <a href="https://overthecap.com/">OverTheCap.com</a>. It is important to remember that much of the information is “nested” and, if you wish to see the yearly information, you must use the <code>unnest()</code> function from <code>tidyr</code>. To highlight this, we can run the following code to bring in the data as it is stored in the <code>nflverse</code>.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/nfl-contracts-load_6cb0e3bc490ab95998194f1e3a64be47">
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nfl_contracts</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_contracts.html">load_contracts</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">nfl_contracts</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "player"              "position"            "team"               
 [4] "is_active"           "year_signed"         "years"              
 [7] "value"               "apy"                 "guaranteed"         
[10] "apy_cap_pct"         "inflated_value"      "inflated_apy"       
[13] "inflated_guaranteed" "player_page"         "otc_id"             
[16] "date_of_birth"       "height"              "weight"             
[19] "college"             "draft_year"          "draft_round"        
[22] "draft_overall"       "draft_team"          "cols"               </code></pre>
</div>
</div>
<p>The returned data includes the contract information for the year in which it was signed, but does not include a year-by-year breakdown of money paid and other relevant information. This data is stored in the <code>cols</code> information and needs to be “opened” up in order to view, like below.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/unnesting-contract-information_d01e53c8965dc1075a13a1ae3e25a6d4">
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nfl_contracts_unnested</span> <span class="op">&lt;-</span> <span class="va">nfl_contracts</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span><span class="op">(</span><span class="va">cols</span>, name_sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">player</span>, <span class="va">year</span>, <span class="va">cash_paid</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">!=</span> <span class="st">"Total"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>cash_paid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">cash_paid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After using the <code>unnest</code> function, we use <code>select()</code> to gather just the player’s name, the year, and the cash paid for each year. After, we use <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> to remove the column that tallies the total of the player’s contact and then <code>mutate()</code> the <code>cash_paid</code> column in order to turn it into a number rather than a character.</p>
<p>We can now bring in other information to compare a player’s cash paid to their performance on the field. I am going to use an example from the final research project from one of my former Sport Analytics students, Matt Dougherty.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> We will compare a player’s yearly pay against their DAKOTA score (which is the adjusted EPA + CPOE composite based on the coefficients which best predict adjusted EPA/play). In order to do so, we must merge each quarterback’s DAKOTA composite based on the year.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/qb-contract-dakota_521f947772816c725afc21b33dad7ff2">
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nfl_contracts_unnested</span> <span class="op">&lt;-</span> <span class="va">nfl_contracts</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span><span class="op">(</span><span class="va">cols</span>, name_sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">player</span>, <span class="va">year</span>, <span class="va">cash_paid</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">!=</span> <span class="st">"Total"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>cash_paid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">cash_paid</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2022</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dakota_composite</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_player_stats.html">load_player_stats</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">position</span> <span class="op">==</span> <span class="st">"QB"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">player_display_name</span>, <span class="va">season</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>attempts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">attempts</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            mean_dakota <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dakota</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">attempts</span> <span class="op">&gt;=</span> <span class="fl">200</span><span class="op">)</span></span>
<span></span>
<span><span class="va">teams</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_teams.html">load_teams</a></span><span class="op">(</span>current <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nfl_contracts_unnested</span> <span class="op">&lt;-</span> <span class="va">nfl_contracts_unnested</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">dakota_composite</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"player"</span> <span class="op">=</span> <span class="st">"player_display_name"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nfl_contracts_unnested</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="va">nfl_contracts_unnested</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nfl_contracts_unnested</span> <span class="op">&lt;-</span> <span class="va">nfl_contracts_unnested</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="va">player</span>, <span class="va">year</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/qb-dakota-cash-plot_7822782774a77ef1a26826c732ebf813">
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">nfl_contracts_unnested</span>,</span>
<span>       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">cash_paid</span>, y <span class="op">=</span> <span class="va">mean_dakota</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">nfl_contracts_unnested</span><span class="op">$</span><span class="va">mean_dakota</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">nfl_contracts_unnested</span><span class="op">$</span><span class="va">cash_paid</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/dollar_format.html">dollar_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Cash Paid (in millions)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Mean DAKOTA Composite"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text_repel</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">player</span><span class="op">)</span>,</span>
<span>                  family <span class="op">=</span> <span class="st">"Roboto"</span>, fontface <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Cash Paid vs. Mean DAKOTA Composite"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"2022 Regular Season"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*An Introduction to NFL Analytics with R*&lt;br&gt;</span></span>
<span><span class="st">       **Brad J. Congelio**"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="03-nfl-analytics-functions_files/figure-html/qb-dakota-cash-plot-1.png" style="width:95.0%;height:95.0%" class="figure-img"></p>
<figcaption class="figure-caption">The relationship between a QB’s average DAKOTA and annual cash paid</figcaption></figure>
</div>
</div>
</div>
<p>Those players in the upper-right quadrant (Mahomes, Allen, Cousins, etc.) are among the highest paid quarterbacks in the league, but also are the highest performing players based on the DAKOTA composite. On the other hand, those QBs in the lower-right quadrant are - based on the DAKOTA composite - overpaid relevant to their performance on the field. The lower-left QBs are not highly paid, but also do not perform well. Those players in the upper-left performed extremely well (some better than those in the upper-right) but come with a team-friendly contract (in terms of pure cash paid).</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>As mentioned in the book’s Preface, you can feel free to reach out to me with questions regarding the R programming language and NFL analytics.</p>
<p>That said, there is a <strong>fantastic</strong> <code>nflverse</code> Discord channel that was created and currently maintained by the creators of the packages (Ben Baldwin, Sebastian Carl, Tan Ho, Thomas Mock, etc.).</p>
<p>You can become a member here: <a href="http://nfl-book.bradcongelio.com/discord-invite" class="uri">http://nfl-book.bradcongelio.com/discord-invite</a></p>
<p>However, before creating a thread and seeking assistance, be sure to visit the “#How To” section in the General Help area to learn to create a <code>reprex</code> (reproducible example). Providing a <code>reprex</code> allows other users to copy and paste your code in order to recreate the issue you are experiencing.</p>
</div>
</div>
</section><section id="the-load_ftn_charting-function" class="level3" data-number="3.5.13"><h3 data-number="3.5.13" class="anchored" data-anchor-id="the-load_ftn_charting-function">
<span class="header-section-number">3.5.13</span> The <code>load_ftn_charting()</code> Function</h3>
<p>As one of the newest additions to the <code>nflverse</code>, users can use the <code>load_ftn_charting()</code> function to pull data compiled by the <a href="https://twitter.com/FTNNetwork">FTN Network</a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>FTN charting data is only available in the <code>nflverse</code> starting with the 2023 season.</p>
</div>
</div>
<p>The data is manually charted and includes the following variables:</p>
<ol type="1">
<li><code>ftn_game_id</code></li>
<li><code>nflverse_game_id</code></li>
<li><code>season</code></li>
<li><code>week</code></li>
<li><code>ftn_play_id</code></li>
<li><code>nflverse_play_id</code></li>
<li><code>starting_hash</code></li>
<li><code>qb_location</code></li>
<li><code>n_offense_backfield</code></li>
<li><code>is_no_huddle</code></li>
<li><code>is_motion</code></li>
<li><code>is_play_action</code></li>
<li><code>is_screen_pass</code></li>
<li><code>is_rpo</code></li>
<li><code>is_trick_play</code></li>
<li><code>is_qb_out_of_pocket</code></li>
<li><code>is_interception_worthy</code></li>
<li><code>is_throw_away</code></li>
<li><code>read_thrown</code></li>
<li><code>is_catchable_ball</code></li>
<li><code>is_contested_ball</code></li>
<li><code>is_created_reception</code></li>
<li><code>is_drop</code></li>
<li><code>is_qb_sneak</code></li>
<li><code>n_blitzers</code></li>
<li><code>n_pass_rushers</code></li>
<li><code>is_qb_fault_sack</code></li>
</ol>
<p>You may notice that the charting data provided by FTN <strong>does not include player information</strong>. Because of this, it is important to take the data as provided from FTN and then merge it into the regular <code>nflverse</code> play-by-play data. Fortunately, because the FTN data includes both the <code>nflverse_game_id</code> and <code>nflverse_play_id</code> variables, the merging process is simple.</p>
<p>To begin, we can collect the FTN charting data from the 2023 season. Since the data includes <em>only</em> the 2023 season, we can go ahead and drop both the <code>week</code> and <code>season</code> variables so that we do not created duplicate versions during the merge.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/reading-in-ftn-data_8a1dc505afd81498fc9dae6c2d09ca9a">
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ftn_data</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_ftn_charting.html">load_ftn_charting</a></span><span class="op">(</span><span class="fl">2023</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">week</span>, <span class="op">-</span><span class="va">season</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In order to merge with the play-by-play data from <code>nflverse</code>, we must bring in the equivalent season of data.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/reading-in-pbp-for-merge_4d0cc0b250d8ee292b1175a94f6bff73">
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pbp</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pbp.html">load_pbp</a></span><span class="op">(</span><span class="fl">2023</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can merge the two sets of data using the unique game and play identifiers provided in each wherein the <code>game_id</code> in <code>pbp</code> matches with <code>nflverse_game_id</code> from <code>ftn_data</code> and <code>play_id</code> from <code>pbp</code> matches with <code>nflverse_play_id</code> from <code>ftn_data</code>.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/merging-ftn-and-nflverse_965e2ed99fc88b96fb0dc99088e25d05">
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pbp</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">ftn_data</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"game_id"</span> <span class="op">=</span> <span class="st">"nflverse_game_id"</span>,</span>
<span>                             <span class="st">"play_id"</span> <span class="op">=</span> <span class="st">"nflverse_play_id"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have now successfully merged the FTN charting data into the <code>nflverse</code> play-by-play data. In order to conduct an exploratory analysis, let’s examine the <code>is_catchable_ball</code> variable from FTN to determine a QB’s accuracy based on air yards (specifically looking at Brock Purdy, Josh Allen, Patrick Mahomes, and Tua Tagovailoa).</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/is-catchable-ball_4fad19abb284dfc1cfd7ebcf9631611a">
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airyards_accu</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">complete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">incomplete_pass</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">down</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">passer</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>total_passes <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">total_passes</span> <span class="op">&gt;=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">passer</span>, <span class="va">posteam</span>, <span class="va">air_yards</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    total_att <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    total_catchable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">is_catchable_ball</span> <span class="op">==</span> <span class="st">"TRUE"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_pct <span class="op">=</span> <span class="va">total_catchable</span> <span class="op">/</span> <span class="va">total_att</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">air_yards</span> <span class="op">&gt;=</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">air_yards</span> <span class="op">&lt;=</span> <span class="fl">25</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We first collect the data for the entire NFL using <code>complete_pass</code>, <code>incomplete_pass</code>, and <code>!is.na(down)</code> to filter down to just pure passing attempts. After, we use <code>group_by()</code> to gather each QB with both their respective teams and then each individual air yard distance (before using a <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> at the very end to limit those attempts that had between 0 and 25 air yards).</p>
<p>Next, we use the <code>load_teams</code> function to gather the team colors for each player, select just the four quarterbacks we want to visualize, and then use <code>ggplot</code> to create the plot.</p>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/prepping-for-ftn-plot_1abc7b109b26ad302f40bef8ddb6e4cb">
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">teams</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_teams.html">load_teams</a></span><span class="op">(</span>current <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">airyards_accu</span> <span class="op">&lt;-</span> <span class="va">airyards_accu</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">teams</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"posteam"</span> <span class="op">=</span> <span class="st">"team_abbr"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">airyards_accu</span> <span class="op">&lt;-</span> <span class="va">airyards_accu</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">passer</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B.Purdy"</span>, <span class="st">"J.Allen"</span>, <span class="st">"T.Tagovailoa"</span>, <span class="st">"P.Mahomes"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="03-nfl-analytics-functions_cache/html/plotting-ftn-data_c76708d167074e0af71d6bbb21898ec8">
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">airyards_accu</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">air_yards</span>, y <span class="op">=</span> <span class="va">total_pct</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">posteam</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nflplotR</span><span class="fu">::</span><span class="fu"><a href="https://nflplotr.nflverse.com/reference/scale_nfl.html">scale_color_nfl</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"primary"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">passer</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Air Yards"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Total % of Catchable Attempts"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**Total % of Catchable Attempts Based on Air Yards**"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"*Minimum 100 Attempts  |  Through Week 5 of 2023 Season*"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*Introduction to NFL Analytics With R*&lt;br&gt;**Bradley J. Congelio**"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="03-nfl-analytics-functions_files/figure-html/plotting-ftn-data-1.png" style="width:95.0%;height:95.0%" class="figure-img"></p>
<figcaption class="figure-caption">Using FTN Data To Examine QB Accuracy Based on Air Yards Distance</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="exercises" class="level2" data-number="3.6"><h2 data-number="3.6" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">3.6</span> Exercises</h2>
<p>The answers for the following answers can be found here: <a href="http://nfl-book.bradcongelio.com/ch3-answers" class="uri">http://nfl-book.bradcongelio.com/ch3-answers</a>.</p>
<section id="exercise-1" class="level3" data-number="3.6.1"><h3 data-number="3.6.1" class="anchored" data-anchor-id="exercise-1">
<span class="header-section-number">3.6.1</span> <strong>Exercise 1</strong>
</h3>
<ol type="1">
<li>Load data from the 2010 to 2022 regular seasons into a data frame titled <code>pbp</code>.</li>
<li>In a data frame titled <code>rushing_success</code>, determine how many rushing attempts each offensive team had on 1st down.</li>
<li>Determine how many of those attempts resulted in a positive EPA (<code>success</code>).</li>
<li>Calculate the percentage of the results into a column titled <code>success_pct</code>.</li>
<li>Arrange the results in descending order by <code>success_pct</code>.</li>
</ol></section><section id="exercise-2" class="level3" data-number="3.6.2"><h3 data-number="3.6.2" class="anchored" data-anchor-id="exercise-2">
<span class="header-section-number">3.6.2</span> Exercise 2</h3>
<p>Load data from the 2022 regular season into a data frame titled <code>pbp_2022</code>.</p>
<ol type="1">
<li>In a data frame titled <code>qb_short_third</code>, determine how many 3rd down passing attempts each QB had.</li>
<li>Determine the number of times the QB’s air yards was less than the required yards to go.</li>
<li>In a column titled <code>ay_percent</code>, calculate the percentage of these results.</li>
<li>Filter the results to those QBs with 100 or more attempts.</li>
<li>Arrange the results in descending order by <code>ay_percent</code>.</li>
</ol></section><section id="exercise-3" class="level3" data-number="3.6.3"><h3 data-number="3.6.3" class="anchored" data-anchor-id="exercise-3">
<span class="header-section-number">3.6.3</span> Exercise 3</h3>
<p>Tom Brady had a long and storied career, serving as a full-time started in the NFL from 2001 to 2022. The <code>qb_epa</code> metric gives a quarterback credit for EPA up to the point where a receivers lost a fumble after a completed catch. For this question, create data frame titled <code>tom_brady</code> and find Brady’s average <code>qb_epa</code> per season, from 2001 to 2022. After, arrange in descending order by his average QB EPA.</p>
</section><section id="exercise-4" class="level3" data-number="3.6.4"><h3 data-number="3.6.4" class="anchored" data-anchor-id="exercise-4">
<span class="header-section-number">3.6.4</span> Exercise 4</h3>
<p>Create a data frame titled <code>made_field_goals</code> and find, between the 2000 and 2022 season, the number of field goal attempts and percentage made on all kicks greater than 40-yards in distance.</p>
</section><section id="exercise-5" class="level3" data-number="3.6.5"><h3 data-number="3.6.5" class="anchored" data-anchor-id="exercise-5">
<span class="header-section-number">3.6.5</span> Exercise 5</h3>
<p>On December 11 of the 2005 season, Pittsburgh’s Jerome Bettis trucked Bears linebacker Brian Urlacher. You can view the play here: <a href="https://www.youtube.com/watch?v=u0mtG-8DWYk">Bettis Trucks Urlacher</a>. Using the <code>load_pbp</code> function, find this specific play (using the video for contextual clues). After, determine how much win probability this individual play added (that is: the differnece between <code>home_wp</code> and <code>home_wp_post</code>.</p>


</section></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>Matt was in my SPT 313 class during the Spring 2023 semester and asked more questions and showed more willingness to learn coding and analytics than all of my prior classes combined. If he is not yet hired by an NFL team, it is a complete injustice.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./02-nfl-analytics-tidyverse.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Wrangling NFL Data in the <code>tidyverse</code></span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./04-nfl-analytics-visualization.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data Visualization with NFL Data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<script src="site_libs/quarto-html/zenscroll-min.js"></script>
<script src="https://platform.twitter.com/widgets.js"></script>
</body></html>